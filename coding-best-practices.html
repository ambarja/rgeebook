<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>Coding Best Practices | Earth Engine with R</title>

    <meta name="author" content="rgee team" />
  
   
   <meta name="generator" content="placeholder" />
  <meta property="og:title" content="Coding Best Practices | Earth Engine with R" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Coding Best Practices | Earth Engine with R" />
  
  
  
  <!-- JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script>
  <script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script>
    <script src="libs/header-attrs-2.11/header-attrs.js"></script>
    <script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet" />
    <script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script>
    <script src="libs/bs3compat-0.3.1/transition.js"></script>
    <script src="libs/bs3compat-0.3.1/tabs.js"></script>
    <script src="libs/bs3compat-0.3.1/bs3compat.js"></script>
    <link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet" />
    <script src="libs/bs4_book-1.0.0/bs4_book.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-141212623-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-141212623-1');
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script>

  <!-- CSS -->
  
</head>

<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book">
    <a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Earth Engine with R</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
      </form>

      <nav aria-label="Table of contents">
        <h2>Table of contents</h2>
        <div id="book-toc"></div>

        <div class="book-extra">
          <p><a id="book-repo" href="#">View book source <i class="fab fa-github"></i></a></li></p>
        </div>
      </nav>
    </div>
  </header>

  <main class="col-sm-12 col-md-9 col-lg-7" id="content">
<div id="coding-best-practices" class="section level1 unnumbered">
<h1>Coding Best Practices</h1>
<p>This section requires the next libraries:</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="coding-best-practices.html#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rgee)</span>
<span id="cb66-2"><a href="coding-best-practices.html#cb66-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3"><a href="coding-best-practices.html#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ee_Initialize</span>()</span></code></pre></div>
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
<style type="text/css">
  body{
    font-size: 15pt;
    font-family: 'Roboto', sans-serif;
  }
  pre code{
    font-size: 12pt;
  }
  .list-group-item:last-child{
    font-size: 11pt;
    font-weight: bold;
  }
</style>
<p>This doc describes coding practices that are intended to maximize the chance of success for complex or expensive Earth Engine computations.</p>
<div id="avoid-mixing-client-functions-and-objects-with-server-functions-and-objects" class="section level2 unnumbered">
<h2><strong>Avoid mixing client functions and objects with server functions and objects</strong></h2>
<p>Earth Engine server objects are objects with constructors that start with <code>ee</code> (e.g. ee$Image, ee$Reducer) and any methods on such objects are server functions. Any object not constructed in this manner is a client object. Client objects may come from the R Earth Engine client (e.g. Map) or the R language (e.g. date, data.frame, c(), list()).</p>
<p>To avoid unintended behavior, do not mix client and server functions in your script as discussed <a href="https://developers.google.com/earth-engine/guides/debugging">here</a>. See <a href="https://developers.google.com/earth-engine/guides/client_server">this page</a> for in-depth explanation of client vs. server in Earth Engine. The following example illustrates the dangers of mixing client and server functionality:</p>
<p><img src="images/thumb_down.png" width=25px>
  <strong>Error</strong> — This code doesn’t work!</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="coding-best-practices.html#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Won&#39;t work.</span></span>
<span id="cb67-2"><a href="coding-best-practices.html#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(table<span class="sc">$</span><span class="fu">size</span>())) {</span>
<span id="cb67-3"><a href="coding-best-practices.html#cb67-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">&#39;No!&#39;</span>) </span>
<span id="cb67-4"><a href="coding-best-practices.html#cb67-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Can you spot the error? Note that <code>table$size()</code> is a server method on a server
object and can not be used with client-side functionality such as the <code>seq_len</code> function.</p>
<p>A situation in which you may want to use for-loops is with to display results
with <code>Map</code>, since the Map object and methods are client-side.</p>
<p><img src="images/thumb_up.png" width=25px>
  <strong>Good</strong> — Use client functions for display Earth Engine spatial objects.</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="coding-best-practices.html#cb68-1" aria-hidden="true" tabindex="-1"></a>l8_ts <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(</span>
<span id="cb68-2"><a href="coding-best-practices.html#cb68-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;LANDSAT/LC08/C01/T1/LC08_044034_%s&quot;</span>,</span>
<span id="cb68-3"><a href="coding-best-practices.html#cb68-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">&quot;20140318&quot;</span>, <span class="st">&quot;20140403&quot;</span>,<span class="st">&quot;20140419&quot;</span>,<span class="st">&quot;20140505&quot;</span>)</span>
<span id="cb68-4"><a href="coding-best-practices.html#cb68-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb68-5"><a href="coding-best-practices.html#cb68-5" aria-hidden="true" tabindex="-1"></a>display_l8ts <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb68-6"><a href="coding-best-practices.html#cb68-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (l8 <span class="cf">in</span> l8_ts) {</span>
<span id="cb68-7"><a href="coding-best-practices.html#cb68-7" aria-hidden="true" tabindex="-1"></a>  ee_l8 <span class="ot">&lt;-</span> ee<span class="sc">$</span><span class="fu">Image</span>(l8)</span>
<span id="cb68-8"><a href="coding-best-practices.html#cb68-8" aria-hidden="true" tabindex="-1"></a>  display_l8ts[[l8]] <span class="ot">&lt;-</span> Map<span class="sc">$</span><span class="fu">addLayer</span>(ee_l8)</span>
<span id="cb68-9"><a href="coding-best-practices.html#cb68-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb68-10"><a href="coding-best-practices.html#cb68-10" aria-hidden="true" tabindex="-1"></a>Map<span class="sc">$</span><span class="fu">centerObject</span>(ee_l8)</span>
<span id="cb68-11"><a href="coding-best-practices.html#cb68-11" aria-hidden="true" tabindex="-1"></a><span class="fu">Reduce</span>(<span class="st">&#39;+&#39;</span>, display_l8ts)</span></code></pre></div>
<p>Conversely, <code>map()</code> is a server function and client functionality won’t work
inside the function passed to map(). For example:</p>
<p><img src="images/thumb_down.png" width=25px>
  <strong>Error</strong> — This code doesn’t work!</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="coding-best-practices.html#cb69-1" aria-hidden="true" tabindex="-1"></a>table <span class="ot">&lt;-</span> ee<span class="sc">$</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;USDOS/LSIB_SIMPLE/2017&#39;</span>)</span>
<span id="cb69-2"><a href="coding-best-practices.html#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Error:</span></span>
<span id="cb69-3"><a href="coding-best-practices.html#cb69-3" aria-hidden="true" tabindex="-1"></a>foobar <span class="ot">&lt;-</span> table<span class="sc">$</span><span class="fu">map</span>(<span class="cf">function</span>(f) {</span>
<span id="cb69-4"><a href="coding-best-practices.html#cb69-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(f); <span class="co"># Can&#39;t use a client function here.</span></span>
<span id="cb69-5"><a href="coding-best-practices.html#cb69-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Can&#39;t Export, either.</span></span>
<span id="cb69-6"><a href="coding-best-practices.html#cb69-6" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p><img src="images/thumb_up.png" width=25px>
  <strong>Good</strong> — Use <code>map()</code> <code>set()</code>.</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="coding-best-practices.html#cb70-1" aria-hidden="true" tabindex="-1"></a>table <span class="ot">&lt;-</span> ee<span class="sc">$</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;USDOS/LSIB_SIMPLE/2017&#39;</span>)</span>
<span id="cb70-2"><a href="coding-best-practices.html#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Do something to every element of a collection.</span></span>
<span id="cb70-3"><a href="coding-best-practices.html#cb70-3" aria-hidden="true" tabindex="-1"></a>withMoreProperties <span class="ot">=</span> table<span class="sc">$</span><span class="fu">map</span>(<span class="cf">function</span>(f) {</span>
<span id="cb70-4"><a href="coding-best-practices.html#cb70-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set a property.</span></span>
<span id="cb70-5"><a href="coding-best-practices.html#cb70-5" aria-hidden="true" tabindex="-1"></a>  f<span class="sc">$</span><span class="fu">set</span>(<span class="st">&quot;area_sq_meters&quot;</span>, f<span class="sc">$</span><span class="fu">area</span>())</span>
<span id="cb70-6"><a href="coding-best-practices.html#cb70-6" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb70-7"><a href="coding-best-practices.html#cb70-7" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(withMoreProperties<span class="sc">$</span><span class="fu">first</span>()<span class="sc">$</span><span class="fu">get</span>(<span class="st">&quot;area_sq_meters&quot;</span>)<span class="sc">$</span><span class="fu">getInfo</span>())</span></code></pre></div>
<p>You can also <code>filter()</code> the collection based on computed or existing properties
and <code>print()</code> the result. Note that you can not print a collection with more
5000 elements. If you get the “Collection query aborted after accumulating over
5000 elements” error, <code>filter()</code> or <code>limit()</code> the collection before printing.</p>
</div>
<div id="avoid-converting-to-list-unnecessarily" class="section level2 unnumbered">
<h2><strong>Avoid converting to list unnecessarily</strong></h2>
<p>Collections in Earth Engine are processed using optimizations that are broken by converting the collection to a <code>List</code> or <code>Array</code> type. Unless you need random access to collection elements (i.e. you need to get the i’th element of a collection), use filters on the collection to access individual collection elements. The following example illustrates the difference between type conversion (not recommended) and filtering (recommended) to access an element in a collection:</p>
<p><img src="images/thumb_down.png" width=25px>
  <strong>Bad</strong> — Don’t convert to list unnecessarily!</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="coding-best-practices.html#cb71-1" aria-hidden="true" tabindex="-1"></a>table <span class="ot">&lt;-</span> ee<span class="sc">$</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;USDOS/LSIB_SIMPLE/2017&#39;</span>);</span>
<span id="cb71-2"><a href="coding-best-practices.html#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Do NOT do this!!</span></span>
<span id="cb71-3"><a href="coding-best-practices.html#cb71-3" aria-hidden="true" tabindex="-1"></a>list <span class="ot">&lt;-</span> table<span class="sc">$</span><span class="fu">toList</span>(table<span class="sc">$</span><span class="fu">size</span>())</span>
<span id="cb71-4"><a href="coding-best-practices.html#cb71-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(list<span class="sc">$</span><span class="fu">get</span>(<span class="dv">13</span>)<span class="sc">$</span><span class="fu">getInfo</span>()) <span class="co"># User memory limit exceeded.</span></span></code></pre></div>
<p>Note that you can easily trigger errors by converting a collection to a list unnecessarily. The safer way is to use <code>filter()</code>:</p>
<p><img src="images/thumb_up.png" width=25px>
  <strong>Good</strong> — Use <code>filter()</code>.</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="coding-best-practices.html#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(table<span class="sc">$</span><span class="fu">filter</span>(ee<span class="sc">$</span>Filter<span class="sc">$</span><span class="fu">eq</span>(<span class="st">&#39;country_na&#39;</span>, <span class="st">&#39;Niger&#39;</span>))<span class="sc">$</span><span class="fu">first</span>()<span class="sc">$</span><span class="fu">getInfo</span>())</span></code></pre></div>
<p>Note that you should <a href="https://developers.google.com/earth-engine/guides/best_practices">use filters as early as possible in your analysis</a>.</p>
</div>
<div id="avoid-ee.algorithms.if" class="section level2 unnumbered">
<h2><strong>Avoid ee.Algorithms.If()</strong></h2>
<p>Do not use <code>ee.Algorithms.If()</code> to implement branching logic, especially in a mapped function. As the following example illustrates, <code>ee.Algorithms.If()</code> can be memory intensive and is not recommended:</p>
<p><img src="images/thumb_down.png" width=25px>
  <strong>Bad</strong> — Don’t use <code>If()</code>:</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="coding-best-practices.html#cb73-1" aria-hidden="true" tabindex="-1"></a>table <span class="ot">&lt;-</span> <span class="fu">ee.FeatureCollection</span>(<span class="st">&#39;USDOS/LSIB_SIMPLE/2017&#39;</span>)</span>
<span id="cb73-2"><a href="coding-best-practices.html#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Do NOT do this!</span></span>
<span id="cb73-3"><a href="coding-best-practices.html#cb73-3" aria-hidden="true" tabindex="-1"></a>veryBad <span class="ot">=</span> table<span class="sc">$</span><span class="fu">map</span>(<span class="cf">function</span>(f) {</span>
<span id="cb73-4"><a href="coding-best-practices.html#cb73-4" aria-hidden="true" tabindex="-1"></a>  ee<span class="sc">$</span>Algorithms<span class="sc">$</span><span class="fu">If</span>(</span>
<span id="cb73-5"><a href="coding-best-practices.html#cb73-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">condition =</span> ee<span class="sc">$</span><span class="fu">String</span>(f<span class="sc">$</span><span class="fu">get</span>(<span class="st">&#39;country_na&#39;</span>))<span class="sc">$</span><span class="fu">compareTo</span>(<span class="st">&#39;Chad&#39;</span>)<span class="sc">$</span><span class="fu">gt</span>(<span class="dv">0</span>),</span>
<span id="cb73-6"><a href="coding-best-practices.html#cb73-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">trueCase =</span> f,      <span class="co"># Do something.</span></span>
<span id="cb73-7"><a href="coding-best-practices.html#cb73-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">falseCase =</span> <span class="cn">NULL</span>   <span class="co"># Do something else.</span></span>
<span id="cb73-8"><a href="coding-best-practices.html#cb73-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb73-9"><a href="coding-best-practices.html#cb73-9" aria-hidden="true" tabindex="-1"></a>}, <span class="cn">TRUE</span>)</span>
<span id="cb73-10"><a href="coding-best-practices.html#cb73-10" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(veryBad<span class="sc">$</span><span class="fu">getInfo</span>()) <span class="co"># User memory limit exceeded.</span></span>
<span id="cb73-11"><a href="coding-best-practices.html#cb73-11" aria-hidden="true" tabindex="-1"></a><span class="co"># If() may evaluate both the true and false cases.</span></span></code></pre></div>
<p>Note that the second argument to <code>map()</code> is <code>TRUE</code>. This means that the mapped
function may return nulls and they will be dropped in the resultant collection.
That can be useful (without <code>If()</code>), but here the easiest solution is to use a
filter:</p>
<p><img src="images/thumb_up.png" width=25px>
  <strong>Good</strong> — Use <code>filter()</code>.</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="coding-best-practices.html#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(table<span class="sc">$</span><span class="fu">filter</span>(ee<span class="sc">$</span>Filter<span class="sc">$</span><span class="fu">eq</span>(<span class="st">&#39;country_na&#39;</span>, <span class="st">&#39;Chad&#39;</span>)))</span></code></pre></div>
<p>As shown in <a href="https://developers.google.com/earth-engine/tutorials/tutorial_js_03">this tutorial</a>, a functional programming approach using filters is the correct way to apply one logic to some elements of a collection and another logic to the other elements of the collection.</p>
</div>
<div id="avoid-reproject" class="section level2 unnumbered">
<h2><strong>Avoid reproject()</strong></h2>
<p>Don’t use <code>reproject</code> unless absolutely necessary. One reason you might want to use reproject() is to force <code>Map</code> display computations to happen at a specific scale so you can examine the results at your desired scale of analysis. In the next example, patches of hot pixels are computed and the count of pixels in each patch is computed. Run the example and click on one of the patches. Note that the count of pixels differs between the reprojected data the data that has not been reprojected.</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="coding-best-practices.html#cb75-1" aria-hidden="true" tabindex="-1"></a>l8sr <span class="ot">&lt;-</span> ee<span class="sc">$</span><span class="fu">ImageCollection</span>(<span class="st">&quot;LANDSAT/LC08/C01/T1_SR&quot;</span>)</span>
<span id="cb75-2"><a href="coding-best-practices.html#cb75-2" aria-hidden="true" tabindex="-1"></a>sf <span class="ot">&lt;-</span> ee<span class="sc">$</span>Geometry<span class="sc">$</span><span class="fu">Point</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="fl">122.405</span>, <span class="fl">37.786</span>))</span>
<span id="cb75-3"><a href="coding-best-practices.html#cb75-3" aria-hidden="true" tabindex="-1"></a>Map<span class="sc">$</span><span class="fu">centerObject</span>(sf, <span class="dv">13</span>)</span>
<span id="cb75-4"><a href="coding-best-practices.html#cb75-4" aria-hidden="true" tabindex="-1"></a><span class="co"># A reason to reproject - counting pixels and exploring interactively.</span></span>
<span id="cb75-5"><a href="coding-best-practices.html#cb75-5" aria-hidden="true" tabindex="-1"></a>image <span class="ot">&lt;-</span> l8sr<span class="sc">$</span><span class="fu">filterBounds</span>(sf)<span class="sc">$</span></span>
<span id="cb75-6"><a href="coding-best-practices.html#cb75-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filterDate</span>(<span class="st">&quot;2019-06-01&quot;</span>, <span class="st">&quot;2019-12-31&quot;</span>)<span class="sc">$</span></span>
<span id="cb75-7"><a href="coding-best-practices.html#cb75-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">first</span>()</span>
<span id="cb75-8"><a href="coding-best-practices.html#cb75-8" aria-hidden="true" tabindex="-1"></a>Map<span class="sc">$</span><span class="fu">addLayer</span>(image, <span class="fu">list</span>(<span class="at">bands =</span> <span class="st">&quot;B10&quot;</span>, <span class="at">min =</span> <span class="dv">2800</span>, <span class="at">max =</span> <span class="dv">3100</span>), <span class="st">&quot;image&quot;</span>)</span>
<span id="cb75-9"><a href="coding-best-practices.html#cb75-9" aria-hidden="true" tabindex="-1"></a>hotspots <span class="ot">&lt;-</span> image<span class="sc">$</span><span class="fu">select</span>(<span class="st">&quot;B10&quot;</span>)<span class="sc">$</span></span>
<span id="cb75-10"><a href="coding-best-practices.html#cb75-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>(<span class="dv">3100</span>)<span class="sc">$</span></span>
<span id="cb75-11"><a href="coding-best-practices.html#cb75-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">selfMask</span>()<span class="sc">$</span></span>
<span id="cb75-12"><a href="coding-best-practices.html#cb75-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="st">&quot;hotspots&quot;</span>)</span>
<span id="cb75-13"><a href="coding-best-practices.html#cb75-13" aria-hidden="true" tabindex="-1"></a>objectSize <span class="ot">&lt;-</span> hotspots<span class="sc">$</span><span class="fu">connectedPixelCount</span>(<span class="dv">256</span>)</span>
<span id="cb75-14"><a href="coding-best-practices.html#cb75-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Beware of reproject!  Don&#39;t zoom out on reprojected data.</span></span>
<span id="cb75-15"><a href="coding-best-practices.html#cb75-15" aria-hidden="true" tabindex="-1"></a>reprojected <span class="ot">&lt;-</span> objectSize<span class="sc">$</span><span class="fu">reproject</span>(hotspots<span class="sc">$</span><span class="fu">projection</span>())</span>
<span id="cb75-16"><a href="coding-best-practices.html#cb75-16" aria-hidden="true" tabindex="-1"></a>Map<span class="sc">$</span><span class="fu">addLayer</span>(objectSize, <span class="fu">list</span>(<span class="at">min =</span> <span class="dv">1</span>, <span class="at">max =</span> <span class="dv">256</span>), <span class="st">&quot;Size No Reproject&quot;</span>, <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb75-17"><a href="coding-best-practices.html#cb75-17" aria-hidden="true" tabindex="-1"></a>Map<span class="sc">$</span><span class="fu">addLayer</span>(reprojected, <span class="fu">list</span>(<span class="at">min =</span> <span class="dv">1</span>, <span class="at">max =</span> <span class="dv">256</span>), <span class="st">&quot;Size Reproject&quot;</span>, <span class="cn">FALSE</span>)</span></code></pre></div>
<p>The reason for the discrepancy is because the <a href="https://developers.google.com/earth-engine/guides/scale">scale of analysis</a> is set by the Code Editor zoom level. By calling <code>reproject()</code> you set the scale of the computation instead of the Map display. Use <code>reproject()</code> with extreme caution for reasons described in <a href="https://developers.google.com/earth-engine/guides/projections">this doc</a>.</p>
</div>
<div id="filter-and-select-first" class="section level2 unnumbered">
<h2><strong>Filter and select() first</strong></h2>
<p>In general, filter input collections by time, location and/or metadata prior to doing anything else with the collection. Apply more selective filters before less selective filters. Spatial and/or temporal filters are often more selective. For example, note that <code>select()</code> and <code>filter()</code> are applied before <code>map()</code>:</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="coding-best-practices.html#cb76-1" aria-hidden="true" tabindex="-1"></a>images <span class="ot">&lt;-</span> ee<span class="sc">$</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR&quot;</span>)</span>
<span id="cb76-2"><a href="coding-best-practices.html#cb76-2" aria-hidden="true" tabindex="-1"></a>sf <span class="ot">&lt;-</span> ee<span class="sc">$</span>Geometry<span class="sc">$</span><span class="fu">Point</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="fl">122.463</span>, <span class="fl">37.768</span>))</span>
<span id="cb76-3"><a href="coding-best-practices.html#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Expensive function to reduce the neighborhood of an image.</span></span>
<span id="cb76-4"><a href="coding-best-practices.html#cb76-4" aria-hidden="true" tabindex="-1"></a>reduceFunction <span class="ot">&lt;-</span> <span class="cf">function</span>(image) {</span>
<span id="cb76-5"><a href="coding-best-practices.html#cb76-5" aria-hidden="true" tabindex="-1"></a>  image<span class="sc">$</span><span class="fu">reduceNeighborhood</span>(</span>
<span id="cb76-6"><a href="coding-best-practices.html#cb76-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">reducer =</span> ee<span class="sc">$</span>Reducer<span class="sc">$</span><span class="fu">mean</span>(),</span>
<span id="cb76-7"><a href="coding-best-practices.html#cb76-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">kernel =</span> ee<span class="sc">$</span>Kernel<span class="sc">$</span><span class="fu">square</span>(<span class="dv">4</span>)</span>
<span id="cb76-8"><a href="coding-best-practices.html#cb76-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb76-9"><a href="coding-best-practices.html#cb76-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb76-10"><a href="coding-best-practices.html#cb76-10" aria-hidden="true" tabindex="-1"></a>bands <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">&quot;B4&quot;</span>, <span class="st">&quot;B3&quot;</span>, <span class="st">&quot;B2&quot;</span>)</span>
<span id="cb76-11"><a href="coding-best-practices.html#cb76-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Select and filter first!</span></span>
<span id="cb76-12"><a href="coding-best-practices.html#cb76-12" aria-hidden="true" tabindex="-1"></a>reasonableComputation <span class="ot">&lt;-</span> images<span class="sc">$</span><span class="fu">select</span>(bands)<span class="sc">$</span></span>
<span id="cb76-13"><a href="coding-best-practices.html#cb76-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filterBounds</span>(sf)<span class="sc">$</span></span>
<span id="cb76-14"><a href="coding-best-practices.html#cb76-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filterDate</span>(<span class="st">&quot;2018-01-01&quot;</span>, <span class="st">&quot;2019-02-01&quot;</span>)<span class="sc">$</span></span>
<span id="cb76-15"><a href="coding-best-practices.html#cb76-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(ee<span class="sc">$</span>Filter<span class="sc">$</span><span class="fu">lt</span>(<span class="st">&quot;CLOUDY_PIXEL_PERCENTAGE&quot;</span>, <span class="dv">1</span>))<span class="sc">$</span></span>
<span id="cb76-16"><a href="coding-best-practices.html#cb76-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aside</span>(ee_print)<span class="sc">$</span> <span class="co"># Useful for debugging.</span></span>
<span id="cb76-17"><a href="coding-best-practices.html#cb76-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(reduceFunction)<span class="sc">$</span></span>
<span id="cb76-18"><a href="coding-best-practices.html#cb76-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reduce</span>(<span class="st">&#39;mean&#39;</span>)<span class="sc">$</span></span>
<span id="cb76-19"><a href="coding-best-practices.html#cb76-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(bands)</span>
<span id="cb76-20"><a href="coding-best-practices.html#cb76-20" aria-hidden="true" tabindex="-1"></a>viz <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">bands =</span> bands, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">10000</span>)</span>
<span id="cb76-21"><a href="coding-best-practices.html#cb76-21" aria-hidden="true" tabindex="-1"></a>Map<span class="sc">$</span><span class="fu">addLayer</span>(reasonableComputation, viz, <span class="st">&quot;resonableComputation&quot;</span>)</span></code></pre></div>
</div>
<div id="use-updatemask-instead-of-mask" class="section level2 unnumbered">
<h2><strong>Use updateMask() instead of mask()</strong></h2>
<p>The difference between <code>updateMask()</code> and <code>mask()</code> is that the former does a logical <code>and()</code> of the argument (the new mask) and the existing image mask whereas <code>mask()</code> simply replaces the image mask with the argument. The danger of the latter is that you can unmask pixels unintentionally. In this example, the goal is to mask pixels less than or equal to 300 meters elevation. As you can see (zoom out), using <code>mask()</code> causes a lot of pixels to become unmasked, pixels that don’t belong in the image of interest:</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="coding-best-practices.html#cb77-1" aria-hidden="true" tabindex="-1"></a>l8sr <span class="ot">&lt;-</span> ee<span class="sc">$</span><span class="fu">ImageCollection</span>(<span class="st">&quot;LANDSAT/LC08/C01/T1_SR&quot;</span>)</span>
<span id="cb77-2"><a href="coding-best-practices.html#cb77-2" aria-hidden="true" tabindex="-1"></a>sf <span class="ot">&lt;-</span> ee<span class="sc">$</span>Geometry<span class="sc">$</span><span class="fu">Point</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="fl">122.40554461769182</span>, <span class="fl">37.786807309873716</span>))</span>
<span id="cb77-3"><a href="coding-best-practices.html#cb77-3" aria-hidden="true" tabindex="-1"></a>aw3d30 <span class="ot">&lt;-</span> ee<span class="sc">$</span><span class="fu">Image</span>(<span class="st">&quot;JAXA/ALOS/AW3D30_V1_1&quot;</span>)</span>
<span id="cb77-4"><a href="coding-best-practices.html#cb77-4" aria-hidden="true" tabindex="-1"></a>Map<span class="sc">$</span><span class="fu">centerObject</span>(sf, <span class="dv">7</span>)</span>
<span id="cb77-5"><a href="coding-best-practices.html#cb77-5" aria-hidden="true" tabindex="-1"></a>image <span class="ot">&lt;-</span> l8sr<span class="sc">$</span><span class="fu">filterBounds</span>(sf)<span class="sc">$</span><span class="fu">filterDate</span>(<span class="st">&quot;2019-06-01&quot;</span>, <span class="st">&quot;2019-12-31&quot;</span>)<span class="sc">$</span><span class="fu">first</span>()</span>
<span id="cb77-6"><a href="coding-best-practices.html#cb77-6" aria-hidden="true" tabindex="-1"></a>vis <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">bands =</span> <span class="fu">c</span>(<span class="st">&quot;B4&quot;</span>, <span class="st">&quot;B3&quot;</span>, <span class="st">&quot;B2&quot;</span>), <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">3000</span>)</span>
<span id="cb77-7"><a href="coding-best-practices.html#cb77-7" aria-hidden="true" tabindex="-1"></a>Map<span class="sc">$</span><span class="fu">addLayer</span>(image, vis, <span class="st">&quot;image&quot;</span>, <span class="cn">FALSE</span>)</span>
<span id="cb77-8"><a href="coding-best-practices.html#cb77-8" aria-hidden="true" tabindex="-1"></a>mask <span class="ot">&lt;-</span> aw3d30<span class="sc">$</span><span class="fu">select</span>(<span class="st">&quot;AVE&quot;</span>)<span class="sc">$</span><span class="fu">gt</span>(<span class="dv">300</span>)</span>
<span id="cb77-9"><a href="coding-best-practices.html#cb77-9" aria-hidden="true" tabindex="-1"></a>Map<span class="sc">$</span><span class="fu">addLayer</span>(mask, {}, <span class="st">&#39;mask&#39;</span>, <span class="cn">FALSE</span>)</span>
<span id="cb77-10"><a href="coding-best-practices.html#cb77-10" aria-hidden="true" tabindex="-1"></a><span class="co"># NO!  Don&#39;t do this!</span></span>
<span id="cb77-11"><a href="coding-best-practices.html#cb77-11" aria-hidden="true" tabindex="-1"></a>badMask <span class="ot">&lt;-</span> image<span class="sc">$</span><span class="fu">mask</span>(mask)</span>
<span id="cb77-12"><a href="coding-best-practices.html#cb77-12" aria-hidden="true" tabindex="-1"></a>Map<span class="sc">$</span><span class="fu">addLayer</span>(badMask, vis, <span class="st">&quot;badMask&quot;</span>)</span>
<span id="cb77-13"><a href="coding-best-practices.html#cb77-13" aria-hidden="true" tabindex="-1"></a>goodMask <span class="ot">&lt;-</span> <span class="fu">image.updateMask</span>(mask)</span>
<span id="cb77-14"><a href="coding-best-practices.html#cb77-14" aria-hidden="true" tabindex="-1"></a>Map<span class="sc">$</span><span class="fu">addLayer</span>(goodMask, vis, <span class="st">&quot;goodMask&quot;</span>, <span class="cn">FALSE</span>)</span></code></pre></div>
</div>
<div id="combine-reducers" class="section level2 unnumbered">
<h2><strong>Combine reducers</strong></h2>
<p>If you need multiple statistics (e.g. mean and standard deviation) from a single input (e.g. an image region), it is more efficient to combine reducers. For example, to get image statistics, combine reducers as follows:</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="coding-best-practices.html#cb78-1" aria-hidden="true" tabindex="-1"></a>image <span class="ot">&lt;-</span> ee<span class="sc">$</span><span class="fu">Image</span>(<span class="st">&#39;COPERNICUS/S2/20150821T111616_20160314T094808_T30UWU&#39;</span>)</span>
<span id="cb78-2"><a href="coding-best-practices.html#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Get mean and SD in every band by combining reducers.</span></span>
<span id="cb78-3"><a href="coding-best-practices.html#cb78-3" aria-hidden="true" tabindex="-1"></a>stats <span class="ot">&lt;-</span> image<span class="sc">$</span><span class="fu">reduceRegion</span>(</span>
<span id="cb78-4"><a href="coding-best-practices.html#cb78-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">reducer =</span> ee<span class="sc">$</span>Reducer<span class="sc">$</span><span class="fu">mean</span>()<span class="sc">$</span><span class="fu">combine</span>(</span>
<span id="cb78-5"><a href="coding-best-practices.html#cb78-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">reducer2 =</span> ee<span class="sc">$</span>Reducer<span class="sc">$</span><span class="fu">stdDev</span>(),</span>
<span id="cb78-6"><a href="coding-best-practices.html#cb78-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">sharedInputs =</span> <span class="cn">TRUE</span></span>
<span id="cb78-7"><a href="coding-best-practices.html#cb78-7" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb78-8"><a href="coding-best-practices.html#cb78-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">geometry =</span> ee<span class="sc">$</span>Geometry<span class="sc">$</span><span class="fu">Rectangle</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="fl">2.15</span>, <span class="fl">48.55</span>, <span class="sc">-</span><span class="fl">1.83</span>, <span class="fl">48.72</span>)),</span>
<span id="cb78-9"><a href="coding-best-practices.html#cb78-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">scale =</span> <span class="dv">10</span>,</span>
<span id="cb78-10"><a href="coding-best-practices.html#cb78-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">bestEffort =</span> <span class="cn">TRUE</span> <span class="co"># Use maxPixels if you care about scale.</span></span>
<span id="cb78-11"><a href="coding-best-practices.html#cb78-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb78-12"><a href="coding-best-practices.html#cb78-12" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(stats<span class="sc">$</span><span class="fu">getInfo</span>())</span>
<span id="cb78-13"><a href="coding-best-practices.html#cb78-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract means and SDs to images.</span></span>
<span id="cb78-14"><a href="coding-best-practices.html#cb78-14" aria-hidden="true" tabindex="-1"></a>meansImage <span class="ot">&lt;-</span> stats<span class="sc">$</span><span class="fu">toImage</span>()<span class="sc">$</span><span class="fu">select</span>(<span class="st">&#39;.*_mean&#39;</span>)</span>
<span id="cb78-15"><a href="coding-best-practices.html#cb78-15" aria-hidden="true" tabindex="-1"></a>sdsImage <span class="ot">&lt;-</span> stats<span class="sc">$</span><span class="fu">toImage</span>()<span class="sc">$</span><span class="fu">select</span>(<span class="st">&#39;.*_stdDev&#39;</span>)</span></code></pre></div>
<p>In this example, note that the mean reducer is combined with the standard deviation reducer and <code>sharedInputs</code> is true to enable a single pass through the input pixels. In the output dictionary, the name of the reducer is appended to the band name. To get mean and SD images (for example to normalize the input image), you can turn the values into an image and use regexes to extract means and SDs individually as demonstrated in the example.</p>
</div>
<div id="use-export" class="section level2 unnumbered">
<h2><strong>Use Export</strong></h2>
<p>For computations that result in “User memory limit exceeded” or “Computation timed out” errors in the Code Editor, the same computations may be able to succeed by using <code>Export</code>. This is because the timeouts are longer and the allowable memory footprint is larger when running in the batch system (where exports run). (There are other approaches you may want to try first as detailed in the debugging doc). Continuing the previous example, suppose that dictionary returned an error. You could obtain the results by doing something like:</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="coding-best-practices.html#cb79-1" aria-hidden="true" tabindex="-1"></a>link <span class="ot">&lt;-</span> <span class="st">&#39;86836482971a35a5e735a17e93c23272&#39;</span></span>
<span id="cb79-2"><a href="coding-best-practices.html#cb79-2" aria-hidden="true" tabindex="-1"></a>task <span class="ot">&lt;-</span> ee<span class="sc">$</span>batch<span class="sc">$</span>Export<span class="sc">$</span>table<span class="sc">$</span><span class="fu">toDrive</span>(</span>
<span id="cb79-3"><a href="coding-best-practices.html#cb79-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">collection =</span> ee<span class="sc">$</span><span class="fu">FeatureCollection</span>(ee<span class="sc">$</span><span class="fu">Feature</span>(<span class="cn">NULL</span>, stats)),</span>
<span id="cb79-4"><a href="coding-best-practices.html#cb79-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">description =</span> <span class="fu">paste0</span>(<span class="st">&quot;exported_stats_demo_&quot;</span>, link),</span>
<span id="cb79-5"><a href="coding-best-practices.html#cb79-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">fileFormat =</span> <span class="st">&quot;CSV&quot;</span></span>
<span id="cb79-6"><a href="coding-best-practices.html#cb79-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb79-7"><a href="coding-best-practices.html#cb79-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Using rgee I/O</span></span>
<span id="cb79-8"><a href="coding-best-practices.html#cb79-8" aria-hidden="true" tabindex="-1"></a>task <span class="ot">&lt;-</span> <span class="fu">ee_table_to_drive</span>(</span>
<span id="cb79-9"><a href="coding-best-practices.html#cb79-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">collection =</span> ee<span class="sc">$</span><span class="fu">FeatureCollection</span>(ee<span class="sc">$</span><span class="fu">Feature</span>(<span class="cn">NULL</span>, stats)),</span>
<span id="cb79-10"><a href="coding-best-practices.html#cb79-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">description =</span> <span class="fu">paste0</span>(<span class="st">&quot;exported_stats_demo_&quot;</span>, link),</span>
<span id="cb79-11"><a href="coding-best-practices.html#cb79-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">fileFormat =</span> <span class="st">&quot;CSV&quot;</span></span>
<span id="cb79-12"><a href="coding-best-practices.html#cb79-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb79-13"><a href="coding-best-practices.html#cb79-13" aria-hidden="true" tabindex="-1"></a>task<span class="sc">$</span><span class="fu">start</span>()</span>
<span id="cb79-14"><a href="coding-best-practices.html#cb79-14" aria-hidden="true" tabindex="-1"></a><span class="fu">ee_monitoring</span>(task)</span>
<span id="cb79-15"><a href="coding-best-practices.html#cb79-15" aria-hidden="true" tabindex="-1"></a>exported_stats <span class="ot">&lt;-</span> <span class="fu">ee_drive_to_local</span>(<span class="at">task =</span> task,<span class="at">dsn =</span> <span class="st">&quot;exported_stats.csv&quot;</span>)</span>
<span id="cb79-16"><a href="coding-best-practices.html#cb79-16" aria-hidden="true" tabindex="-1"></a><span class="fu">read.csv</span>(exported_stats)</span></code></pre></div>
<p>Note that the link is embedded into the asset name, for reproducibility. Also note that if you want to export <code>toAsset</code>, you will need to supply a geometry, which can be anything, for example the image centroid, which is small and cheap to compute. (i.e. don’t use a complex geometry if you don’t need it).</p>
<p>See the debugging page for examples of using <code>Export</code> to resolve <a href="https://developers.google.com/earth-engine/guides/debugging">Computation</a> timed out and <a href="https://developers.google.com/earth-engine/guides/debugging">Too many concurrent aggregations</a>. See <a href="https://developers.google.com/earth-engine/guides/exporting">this doc</a> for details on exporting in general.</p>
</div>
<div id="if-you-dont-need-to-clip-dont-use-clip" class="section level2 unnumbered">
<h2><strong>If you don’t need to clip, don’t use clip() </strong></h2>
<p>Using <code>clip()</code> unnecessarily will increase computation time. Avoid <code>clip()</code> unless it’s necessary to your analysis. If you’re not sure, don’t clip. An example of a bad use of clip:</p>
<p><img src="images/thumb_down.png" width=25px>
  <strong>Bad</strong> — Don’t clip inputs unnecessarily!</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="coding-best-practices.html#cb80-1" aria-hidden="true" tabindex="-1"></a>table <span class="ot">&lt;-</span> ee<span class="sc">$</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;USDOS/LSIB_SIMPLE/2017&#39;</span>)</span>
<span id="cb80-2"><a href="coding-best-practices.html#cb80-2" aria-hidden="true" tabindex="-1"></a>l8sr <span class="ot">&lt;-</span> ee<span class="sc">$</span><span class="fu">ImageCollection</span>(<span class="st">&#39;LANDSAT/LC08/C01/T1_SR&#39;</span>)</span>
<span id="cb80-3"><a href="coding-best-practices.html#cb80-3" aria-hidden="true" tabindex="-1"></a>chad <span class="ot">&lt;-</span> table<span class="sc">$</span><span class="fu">filter</span>(ee<span class="sc">$</span>Filter<span class="sc">$</span><span class="fu">eq</span>(<span class="st">&#39;country_na&#39;</span>, <span class="st">&#39;Chad&#39;</span>))<span class="sc">$</span><span class="fu">first</span>()</span>
<span id="cb80-4"><a href="coding-best-practices.html#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Do NOT clip unless you need to.</span></span>
<span id="cb80-5"><a href="coding-best-practices.html#cb80-5" aria-hidden="true" tabindex="-1"></a>unnecessaryClip <span class="ot">&lt;-</span> l8sr<span class="sc">$</span></span>
<span id="cb80-6"><a href="coding-best-practices.html#cb80-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="st">&#39;B4&#39;</span>)<span class="sc">$</span>                           <span class="co"># Good.</span></span>
<span id="cb80-7"><a href="coding-best-practices.html#cb80-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filterBounds</span>(chad<span class="sc">$</span><span class="fu">geometry</span>())<span class="sc">$</span>          <span class="co"># Good.</span></span>
<span id="cb80-8"><a href="coding-best-practices.html#cb80-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filterDate</span>(<span class="st">&#39;2019-01-01&#39;</span>, <span class="st">&#39;2019-12-31&#39;</span>)<span class="sc">$</span> <span class="co"># Good.</span></span>
<span id="cb80-9"><a href="coding-best-practices.html#cb80-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(<span class="cf">function</span>(image) {</span>
<span id="cb80-10"><a href="coding-best-practices.html#cb80-10" aria-hidden="true" tabindex="-1"></a>    image<span class="sc">$</span><span class="fu">clip</span>(chad<span class="sc">$</span><span class="fu">geometry</span>())   <span class="co"># NO! Bad! Not necessary.</span></span>
<span id="cb80-11"><a href="coding-best-practices.html#cb80-11" aria-hidden="true" tabindex="-1"></a>  })<span class="sc">$</span></span>
<span id="cb80-12"><a href="coding-best-practices.html#cb80-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">median</span>()<span class="sc">$</span></span>
<span id="cb80-13"><a href="coding-best-practices.html#cb80-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reduceRegion</span>(</span>
<span id="cb80-14"><a href="coding-best-practices.html#cb80-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">reducer =</span> ee<span class="sc">$</span>Reducer<span class="sc">$</span><span class="fu">mean</span>(),</span>
<span id="cb80-15"><a href="coding-best-practices.html#cb80-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">geometry =</span> chad<span class="sc">$</span><span class="fu">geometry</span>(),</span>
<span id="cb80-16"><a href="coding-best-practices.html#cb80-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">scale =</span> <span class="dv">30</span>,</span>
<span id="cb80-17"><a href="coding-best-practices.html#cb80-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">maxPixels =</span> <span class="fl">1e10</span></span>
<span id="cb80-18"><a href="coding-best-practices.html#cb80-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb80-19"><a href="coding-best-practices.html#cb80-19" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(unnecessaryClip<span class="sc">$</span><span class="fu">getInfo</span>())</span></code></pre></div>
<p>Clipping the input images can be skipped entirely, because the region is specified in the <code>reduceRegion()</code> call:</p>
<p><img src="images/thumb_up.png" width=25px>
  <strong>Good</strong> — Specify the region on the output.</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="coding-best-practices.html#cb81-1" aria-hidden="true" tabindex="-1"></a>noClipNeeded <span class="ot">&lt;-</span> l8sr<span class="sc">$</span></span>
<span id="cb81-2"><a href="coding-best-practices.html#cb81-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="st">&#39;B4&#39;</span>)<span class="sc">$</span>                          <span class="co"># Good.</span></span>
<span id="cb81-3"><a href="coding-best-practices.html#cb81-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filterBounds</span>(chad<span class="sc">$</span><span class="fu">geometry</span>())<span class="sc">$</span>          <span class="co"># Good.</span></span>
<span id="cb81-4"><a href="coding-best-practices.html#cb81-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filterDate</span>(<span class="st">&#39;2019-01-01&#39;</span>, <span class="st">&#39;2019-12-31&#39;</span>)<span class="sc">$</span> <span class="co"># Good.</span></span>
<span id="cb81-5"><a href="coding-best-practices.html#cb81-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">median</span>()<span class="sc">$</span></span>
<span id="cb81-6"><a href="coding-best-practices.html#cb81-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reduceRegion</span>(</span>
<span id="cb81-7"><a href="coding-best-practices.html#cb81-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">reducer =</span> ee<span class="sc">$</span>Reducer<span class="sc">$</span><span class="fu">mean</span>(),</span>
<span id="cb81-8"><a href="coding-best-practices.html#cb81-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">geometry =</span> chad<span class="sc">$</span><span class="fu">geometry</span>(), <span class="co"># Geometry is specified here.</span></span>
<span id="cb81-9"><a href="coding-best-practices.html#cb81-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">scale =</span> <span class="dv">30</span>,</span>
<span id="cb81-10"><a href="coding-best-practices.html#cb81-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">maxPixels =</span> <span class="fl">1e10</span></span>
<span id="cb81-11"><a href="coding-best-practices.html#cb81-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb81-12"><a href="coding-best-practices.html#cb81-12" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(noClipNeeded<span class="sc">$</span><span class="fu">getInfo</span>())</span></code></pre></div>
<p>If this computation times out, <code>Export</code> it as in <a href="https://developers.google.com/earth-engine/guides/best_practices">this example</a>.</p>
</div>
<div id="if-you-need-to-clip-with-a-complex-collection-use-cliptocollection" class="section level2 unnumbered">
<h2><strong>If you need to clip with a complex collection, use clipToCollection()</strong></h2>
<p>If you really need to clip something, and the geometries you want to use for clipping are in a collection, use <code>clipToCollection()</code>:</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="coding-best-practices.html#cb82-1" aria-hidden="true" tabindex="-1"></a>ecoregions <span class="ot">&lt;-</span> ee<span class="sc">$</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;RESOLVE/ECOREGIONS/2017&#39;</span>)</span>
<span id="cb82-2"><a href="coding-best-practices.html#cb82-2" aria-hidden="true" tabindex="-1"></a>image <span class="ot">&lt;-</span> ee<span class="sc">$</span><span class="fu">Image</span>(<span class="st">&#39;JAXA/ALOS/AW3D30_V1_1&#39;</span>)</span>
<span id="cb82-3"><a href="coding-best-practices.html#cb82-3" aria-hidden="true" tabindex="-1"></a>complexCollection <span class="ot">&lt;-</span> ecoregions<span class="sc">$</span></span>
<span id="cb82-4"><a href="coding-best-practices.html#cb82-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb82-5"><a href="coding-best-practices.html#cb82-5" aria-hidden="true" tabindex="-1"></a>    ee<span class="sc">$</span>Filter<span class="sc">$</span><span class="fu">eq</span>(</span>
<span id="cb82-6"><a href="coding-best-practices.html#cb82-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;BIOME_NAME&#39;</span>,</span>
<span id="cb82-7"><a href="coding-best-practices.html#cb82-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;Tropical &amp; Subtropical Moist Broadleaf Forests&#39;</span></span>
<span id="cb82-8"><a href="coding-best-practices.html#cb82-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb82-9"><a href="coding-best-practices.html#cb82-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb82-10"><a href="coding-best-practices.html#cb82-10" aria-hidden="true" tabindex="-1"></a>Map<span class="sc">$</span><span class="fu">addLayer</span>(complexCollection, {}, <span class="st">&#39;complexCollection&#39;</span>)</span>
<span id="cb82-11"><a href="coding-best-practices.html#cb82-11" aria-hidden="true" tabindex="-1"></a>clippedTheRightWay <span class="ot">&lt;-</span> image<span class="sc">$</span><span class="fu">select</span>(<span class="st">&#39;AVE&#39;</span>)<span class="sc">$</span></span>
<span id="cb82-12"><a href="coding-best-practices.html#cb82-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">clipToCollection</span>(complexCollection)</span>
<span id="cb82-13"><a href="coding-best-practices.html#cb82-13" aria-hidden="true" tabindex="-1"></a>Map<span class="sc">$</span><span class="fu">addLayer</span>(clippedTheRightWay, {}, <span class="st">&#39;clippedTheRightWay&#39;</span>, <span class="cn">FALSE</span>)</span></code></pre></div>
<p>Do NOT use <code>featureCollection.geometry()</code> or <code>featureCollection.union()</code> on
large and/or complex collections, which can be more memory intensive.</p>
</div>
<div id="dont-use-a-complex-collection-as-the-region-for-a-reducer" class="section level2 unnumbered">
<h2><strong>Don’t use a complex collection as the region for a reducer</strong></h2>
<p>If you need to do a spatial reduction such that the reducer pools inputs from multiple regions in a <code>FeatureCollection</code>, don’t supply <code>featureCollection.geometry()</code> as the <code>geometry</code> input to the reducer. Instead, use <code>clipToCollection()</code> and a region large enough to encompass the bounds of the collection. For example:</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="coding-best-practices.html#cb83-1" aria-hidden="true" tabindex="-1"></a>ecoregions <span class="ot">&lt;-</span> ee<span class="sc">$</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;RESOLVE/ECOREGIONS/2017&#39;</span>)</span>
<span id="cb83-2"><a href="coding-best-practices.html#cb83-2" aria-hidden="true" tabindex="-1"></a>image <span class="ot">&lt;-</span> ee<span class="sc">$</span><span class="fu">Image</span>(<span class="st">&#39;JAXA/ALOS/AW3D30_V1_1&#39;</span>)</span>
<span id="cb83-3"><a href="coding-best-practices.html#cb83-3" aria-hidden="true" tabindex="-1"></a>complexCollection <span class="ot">&lt;-</span> ecoregions<span class="sc">$</span><span class="fu">filter</span>(</span>
<span id="cb83-4"><a href="coding-best-practices.html#cb83-4" aria-hidden="true" tabindex="-1"></a>  ee<span class="sc">$</span>Filter<span class="sc">$</span><span class="fu">eq</span>(<span class="st">&#39;BIOME_NAME&#39;</span>, <span class="st">&#39;Tropical &amp; Subtropical Moist Broadleaf Forests&#39;</span>)</span>
<span id="cb83-5"><a href="coding-best-practices.html#cb83-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb83-6"><a href="coding-best-practices.html#cb83-6" aria-hidden="true" tabindex="-1"></a>clippedTheRightWay <span class="ot">&lt;-</span> image<span class="sc">$</span><span class="fu">select</span>(<span class="st">&#39;AVE&#39;</span>)<span class="sc">$</span><span class="fu">clipToCollection</span>(complexCollection)</span>
<span id="cb83-7"><a href="coding-best-practices.html#cb83-7" aria-hidden="true" tabindex="-1"></a>Map<span class="sc">$</span><span class="fu">addLayer</span>(clippedTheRightWay, {}, <span class="st">&#39;clippedTheRightWay&#39;</span>)</span>
<span id="cb83-8"><a href="coding-best-practices.html#cb83-8" aria-hidden="true" tabindex="-1"></a>reduction <span class="ot">&lt;-</span> clippedTheRightWay<span class="sc">$</span><span class="fu">reduceRegion</span>(</span>
<span id="cb83-9"><a href="coding-best-practices.html#cb83-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">reducer =</span> ee<span class="sc">$</span>Reducer<span class="sc">$</span><span class="fu">mean</span>(),</span>
<span id="cb83-10"><a href="coding-best-practices.html#cb83-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">geometry =</span> ee<span class="sc">$</span>Geometry<span class="sc">$</span><span class="fu">Rectangle</span>(</span>
<span id="cb83-11"><a href="coding-best-practices.html#cb83-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">coords =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">179.9</span>, <span class="sc">-</span><span class="dv">50</span>, <span class="fl">179.9</span>, <span class="dv">50</span>),  <span class="co"># Almost global.</span></span>
<span id="cb83-12"><a href="coding-best-practices.html#cb83-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">geodesic =</span> <span class="cn">FALSE</span></span>
<span id="cb83-13"><a href="coding-best-practices.html#cb83-13" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb83-14"><a href="coding-best-practices.html#cb83-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">scale =</span> <span class="dv">30</span>,</span>
<span id="cb83-15"><a href="coding-best-practices.html#cb83-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">maxPixels =</span> <span class="fl">1e12</span></span>
<span id="cb83-16"><a href="coding-best-practices.html#cb83-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb83-17"><a href="coding-best-practices.html#cb83-17" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(reduction<span class="sc">$</span><span class="fu">getInfo</span>()) <span class="co"># If this times out, export it.</span></span></code></pre></div>
</div>
<div id="use-a-non-zero-errormargin" class="section level2 unnumbered">
<h2><strong>Use a non-zero errorMargin</strong></h2>
<p>For possibly expensive geometry operations, use the largest error margin possible given the required precision of the computation. The error margin specifies the maximum allowable error (in meters) permitted during operations on geometries (e.g. during reprojection). Specifying a small error margin can result in the need to densify geometries (with coordinates), which can be memory intensive. It’s good practice to specify as large an error margin as possible for your computation:</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="coding-best-practices.html#cb84-1" aria-hidden="true" tabindex="-1"></a>ecoregions <span class="ot">&lt;-</span> ee<span class="sc">$</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;RESOLVE/ECOREGIONS/2017&quot;</span>)</span>
<span id="cb84-2"><a href="coding-best-practices.html#cb84-2" aria-hidden="true" tabindex="-1"></a>complexCollection <span class="ot">&lt;-</span> ecoregions<span class="sc">$</span><span class="fu">limit</span>(<span class="dv">10</span>)</span>
<span id="cb84-3"><a href="coding-best-practices.html#cb84-3" aria-hidden="true" tabindex="-1"></a>Map<span class="sc">$</span><span class="fu">centerObject</span>(complexCollection)</span>
<span id="cb84-4"><a href="coding-best-practices.html#cb84-4" aria-hidden="true" tabindex="-1"></a>Map<span class="sc">$</span><span class="fu">addLayer</span>(complexCollection)</span>
<span id="cb84-5"><a href="coding-best-practices.html#cb84-5" aria-hidden="true" tabindex="-1"></a>expensiveOps <span class="ot">&lt;-</span> complexCollection<span class="sc">$</span><span class="fu">map</span>(<span class="cf">function</span>(f) {</span>
<span id="cb84-6"><a href="coding-best-practices.html#cb84-6" aria-hidden="true" tabindex="-1"></a>  f<span class="sc">$</span><span class="fu">buffer</span>(<span class="dv">10000</span>, <span class="dv">200</span>)<span class="sc">$</span><span class="fu">bounds</span>(<span class="dv">200</span>)</span>
<span id="cb84-7"><a href="coding-best-practices.html#cb84-7" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb84-8"><a href="coding-best-practices.html#cb84-8" aria-hidden="true" tabindex="-1"></a>Map<span class="sc">$</span><span class="fu">addLayer</span>(expensiveOps, {}, <span class="st">&#39;expensiveOps&#39;</span>)</span></code></pre></div>
</div>
<div id="dont-use-a-ridiculously-small-scale-with-reducetovectors" class="section level2 unnumbered">
<h2><strong>Don’t use a ridiculously small scale with reduceToVectors()</strong></h2>
<p>If you want to convert a raster to a vector, use an appropriate scale. Specifying a very small scale can substantially increase computation cost. Set scale as high as possible give the required precision. For example, to get polygons representing global land masses:</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="coding-best-practices.html#cb85-1" aria-hidden="true" tabindex="-1"></a>etopo <span class="ot">&lt;-</span> ee<span class="sc">$</span><span class="fu">Image</span>(<span class="st">&#39;NOAA/NGDC/ETOPO1&#39;</span>)</span>
<span id="cb85-2"><a href="coding-best-practices.html#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Approximate land boundary.</span></span>
<span id="cb85-3"><a href="coding-best-practices.html#cb85-3" aria-hidden="true" tabindex="-1"></a>bounds <span class="ot">&lt;-</span> etopo<span class="sc">$</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="sc">$</span><span class="fu">gt</span>(<span class="sc">-</span><span class="dv">100</span>)</span>
<span id="cb85-4"><a href="coding-best-practices.html#cb85-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Non-geodesic polygon.</span></span>
<span id="cb85-5"><a href="coding-best-practices.html#cb85-5" aria-hidden="true" tabindex="-1"></a>almostGlobal <span class="ot">&lt;-</span> ee<span class="sc">$</span>Geometry<span class="sc">$</span><span class="fu">Polygon</span>(</span>
<span id="cb85-6"><a href="coding-best-practices.html#cb85-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">coords =</span> <span class="fu">list</span>(</span>
<span id="cb85-7"><a href="coding-best-practices.html#cb85-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="sc">-</span><span class="dv">180</span>, <span class="sc">-</span><span class="dv">80</span>),</span>
<span id="cb85-8"><a href="coding-best-practices.html#cb85-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="dv">180</span>, <span class="sc">-</span><span class="dv">80</span>),</span>
<span id="cb85-9"><a href="coding-best-practices.html#cb85-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="dv">180</span>, <span class="dv">80</span>),</span>
<span id="cb85-10"><a href="coding-best-practices.html#cb85-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="sc">-</span><span class="dv">180</span>, <span class="dv">80</span>),</span>
<span id="cb85-11"><a href="coding-best-practices.html#cb85-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="sc">-</span><span class="dv">180</span>, <span class="sc">-</span><span class="dv">80</span>)</span>
<span id="cb85-12"><a href="coding-best-practices.html#cb85-12" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb85-13"><a href="coding-best-practices.html#cb85-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">proj =</span> <span class="st">&quot;EPSG:4326&quot;</span>,</span>
<span id="cb85-14"><a href="coding-best-practices.html#cb85-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">geodesic =</span> <span class="cn">FALSE</span></span>
<span id="cb85-15"><a href="coding-best-practices.html#cb85-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb85-16"><a href="coding-best-practices.html#cb85-16" aria-hidden="true" tabindex="-1"></a>Map<span class="sc">$</span><span class="fu">addLayer</span>(almostGlobal, {}, <span class="st">&quot;almostGlobal&quot;</span>)</span>
<span id="cb85-17"><a href="coding-best-practices.html#cb85-17" aria-hidden="true" tabindex="-1"></a>vectors <span class="ot">&lt;-</span> bounds<span class="sc">$</span><span class="fu">selfMask</span>()<span class="sc">$</span><span class="fu">reduceToVectors</span>(</span>
<span id="cb85-18"><a href="coding-best-practices.html#cb85-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">reducer =</span> ee<span class="sc">$</span>Reducer<span class="sc">$</span><span class="fu">countEvery</span>(),</span>
<span id="cb85-19"><a href="coding-best-practices.html#cb85-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">geometry =</span> almostGlobal,</span>
<span id="cb85-20"><a href="coding-best-practices.html#cb85-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set the scale to the maximum possible given</span></span>
<span id="cb85-21"><a href="coding-best-practices.html#cb85-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># the required precision of the computation.</span></span>
<span id="cb85-22"><a href="coding-best-practices.html#cb85-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">scale =</span> <span class="dv">50000</span></span>
<span id="cb85-23"><a href="coding-best-practices.html#cb85-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb85-24"><a href="coding-best-practices.html#cb85-24" aria-hidden="true" tabindex="-1"></a>Map<span class="sc">$</span><span class="fu">addLayer</span>(vectors, {}, <span class="st">&quot;vectors&quot;</span>)</span></code></pre></div>
<p>In the previous example, note the use of a non-geodesic polygon for use in global reductions.</p>
</div>
<div id="dont-use-reducetovectors-with-reduceregions" class="section level2 unnumbered">
<h2><strong>Don’t use reduceToVectors() with reduceRegions()</strong></h2>
<p>Don’t use a <code>FeatureCollection</code> returned by <code>reduceToVectors()</code> as an input to <code>reduceRegions()</code>. Instead, add the bands you want to reduce before calling <code>reduceToVectors()</code>:</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="coding-best-practices.html#cb86-1" aria-hidden="true" tabindex="-1"></a>etopo <span class="ot">&lt;-</span> ee<span class="sc">$</span><span class="fu">Image</span>(<span class="st">&#39;NOAA/NGDC/ETOPO1&#39;</span>)</span>
<span id="cb86-2"><a href="coding-best-practices.html#cb86-2" aria-hidden="true" tabindex="-1"></a>mod11a1 <span class="ot">&lt;-</span> ee<span class="sc">$</span><span class="fu">ImageCollection</span>(<span class="st">&#39;MODIS/006/MOD11A1&#39;</span>)</span>
<span id="cb86-3"><a href="coding-best-practices.html#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Approximate land boundary.</span></span>
<span id="cb86-4"><a href="coding-best-practices.html#cb86-4" aria-hidden="true" tabindex="-1"></a>bounds <span class="ot">&lt;-</span> etopo<span class="sc">$</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="sc">$</span><span class="fu">gt</span>(<span class="sc">-</span><span class="dv">100</span>)</span>
<span id="cb86-5"><a href="coding-best-practices.html#cb86-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Non-geodesic polygon.</span></span>
<span id="cb86-6"><a href="coding-best-practices.html#cb86-6" aria-hidden="true" tabindex="-1"></a>almostGlobal <span class="ot">&lt;-</span> ee<span class="sc">$</span>Geometry<span class="sc">$</span><span class="fu">Polygon</span>(</span>
<span id="cb86-7"><a href="coding-best-practices.html#cb86-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">coords =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">180</span>, <span class="sc">-</span><span class="dv">80</span>), <span class="fu">c</span>(<span class="dv">180</span>, <span class="sc">-</span><span class="dv">80</span>), <span class="fu">c</span>(<span class="dv">180</span>, <span class="dv">80</span>), <span class="fu">c</span>(<span class="sc">-</span><span class="dv">180</span>, <span class="dv">80</span>), <span class="fu">c</span>(<span class="sc">-</span><span class="dv">180</span>, <span class="sc">-</span><span class="dv">80</span>)),</span>
<span id="cb86-8"><a href="coding-best-practices.html#cb86-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">proj =</span> <span class="st">&quot;EPSG:4326&quot;</span>,</span>
<span id="cb86-9"><a href="coding-best-practices.html#cb86-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">geodesic =</span> <span class="cn">FALSE</span></span>
<span id="cb86-10"><a href="coding-best-practices.html#cb86-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb86-11"><a href="coding-best-practices.html#cb86-11" aria-hidden="true" tabindex="-1"></a>lst <span class="ot">&lt;-</span> mod11a1<span class="sc">$</span><span class="fu">first</span>()<span class="sc">$</span><span class="fu">select</span>(<span class="dv">0</span>)</span>
<span id="cb86-12"><a href="coding-best-practices.html#cb86-12" aria-hidden="true" tabindex="-1"></a>means <span class="ot">&lt;-</span> bounds<span class="sc">$</span><span class="fu">selfMask</span>()<span class="sc">$</span><span class="fu">addBands</span>(lst)<span class="sc">$</span><span class="fu">reduceToVectors</span>(</span>
<span id="cb86-13"><a href="coding-best-practices.html#cb86-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">reducer =</span> ee<span class="sc">$</span>Reducer<span class="sc">$</span><span class="fu">mean</span>(),</span>
<span id="cb86-14"><a href="coding-best-practices.html#cb86-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">geometry =</span> almostGlobal,</span>
<span id="cb86-15"><a href="coding-best-practices.html#cb86-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">scale =</span> <span class="dv">1000</span>,</span>
<span id="cb86-16"><a href="coding-best-practices.html#cb86-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">maxPixels =</span> <span class="fl">1e10</span></span>
<span id="cb86-17"><a href="coding-best-practices.html#cb86-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb86-18"><a href="coding-best-practices.html#cb86-18" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(means<span class="sc">$</span><span class="fu">limit</span>(<span class="dv">10</span>)<span class="sc">$</span><span class="fu">getInfo</span>())</span></code></pre></div>
<p>Note that other ways of reducing pixels of one image within zones of another include <a href="https://developers.google.com/earth-engine/api_docs#ee.image.reduceconnectedcomponents/">reduceConnectedCommponents()</a> and/or <a href="https://developers.google.com/earth-engine/api_docs#ee.image.reduceconnectedcomponents/">grouping reducers</a>.</p>
</div>
<div id="use-fastdistancetransform-for-neighborhood-operations" class="section level2 unnumbered">
<h2><strong>Use fastDistanceTransform() for neighborhood operations</strong></h2>
<p>For some convolution operations, <code>fastDistanceTransform()</code> may be more efficient than <code>reduceNeighborhood()</code> or <code>convolve()</code>. For example, to do erosion and/or dilation of binary inputs:</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="coding-best-practices.html#cb87-1" aria-hidden="true" tabindex="-1"></a>aw3d30 <span class="ot">&lt;-</span> ee<span class="sc">$</span><span class="fu">Image</span>(<span class="st">&quot;JAXA/ALOS/AW3D30_V1_1&quot;</span>)</span>
<span id="cb87-2"><a href="coding-best-practices.html#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Make a simple binary layer from a threshold on elevation.</span></span>
<span id="cb87-3"><a href="coding-best-practices.html#cb87-3" aria-hidden="true" tabindex="-1"></a>mask <span class="ot">&lt;-</span> aw3d30<span class="sc">$</span><span class="fu">select</span>(<span class="st">&quot;AVE&quot;</span>)<span class="sc">$</span><span class="fu">gt</span>(<span class="dv">300</span>)</span>
<span id="cb87-4"><a href="coding-best-practices.html#cb87-4" aria-hidden="true" tabindex="-1"></a>Map<span class="sc">$</span><span class="fu">setCenter</span>(<span class="sc">-</span><span class="fl">122.0703</span>, <span class="fl">37.3872</span>, <span class="dv">11</span>)</span>
<span id="cb87-5"><a href="coding-best-practices.html#cb87-5" aria-hidden="true" tabindex="-1"></a>Map<span class="sc">$</span><span class="fu">addLayer</span>(mask, {}, <span class="st">&quot;mask&quot;</span>)</span>
<span id="cb87-6"><a href="coding-best-practices.html#cb87-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Distance in pixel units.</span></span>
<span id="cb87-7"><a href="coding-best-practices.html#cb87-7" aria-hidden="true" tabindex="-1"></a>distance <span class="ot">&lt;-</span> mask<span class="sc">$</span><span class="fu">fastDistanceTransform</span>()<span class="sc">$</span><span class="fu">sqrt</span>()</span>
<span id="cb87-8"><a href="coding-best-practices.html#cb87-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Threshold on distance (three pixels) for a dilation.</span></span>
<span id="cb87-9"><a href="coding-best-practices.html#cb87-9" aria-hidden="true" tabindex="-1"></a>dilation <span class="ot">&lt;-</span> distance<span class="sc">$</span><span class="fu">lt</span>(<span class="dv">3</span>)</span>
<span id="cb87-10"><a href="coding-best-practices.html#cb87-10" aria-hidden="true" tabindex="-1"></a>Map<span class="sc">$</span><span class="fu">addLayer</span>(dilation, {}, <span class="st">&quot;dilation&quot;</span>)</span>
<span id="cb87-11"><a href="coding-best-practices.html#cb87-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Do the reverse for an erosion.</span></span>
<span id="cb87-12"><a href="coding-best-practices.html#cb87-12" aria-hidden="true" tabindex="-1"></a>notDistance <span class="ot">&lt;-</span> mask<span class="sc">$</span><span class="fu">Not</span>()<span class="sc">$</span><span class="fu">fastDistanceTransform</span>()<span class="sc">$</span><span class="fu">sqrt</span>()</span>
<span id="cb87-13"><a href="coding-best-practices.html#cb87-13" aria-hidden="true" tabindex="-1"></a>erosion <span class="ot">&lt;-</span> notDistance<span class="sc">$</span><span class="fu">gt</span>(<span class="dv">3</span>)</span>
<span id="cb87-14"><a href="coding-best-practices.html#cb87-14" aria-hidden="true" tabindex="-1"></a>Map<span class="sc">$</span><span class="fu">addLayer</span>(erosion, {}, <span class="st">&#39;erosion&#39;</span>)</span></code></pre></div>
</div>
<div id="use-the-optimizations-in-reduceneighborhood" class="section level2 unnumbered">
<h2><strong>Use the optimizations in reduceNeighborhood()</strong></h2>
<p>If you need to perform a convolution and can’t use <code>fastDistanceTransform()</code>, use the optimizations in <code>reduceNeighborhood()</code>.</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="coding-best-practices.html#cb88-1" aria-hidden="true" tabindex="-1"></a>l8raw <span class="ot">&lt;-</span> ee<span class="sc">$</span><span class="fu">ImageCollection</span>(<span class="st">&#39;LANDSAT/LC08/C01/T1_RT&#39;</span>)</span>
<span id="cb88-2"><a href="coding-best-practices.html#cb88-2" aria-hidden="true" tabindex="-1"></a>composite <span class="ot">&lt;-</span> ee<span class="sc">$</span>Algorithms<span class="sc">$</span>Landsat<span class="sc">$</span><span class="fu">simpleComposite</span>(l8raw)</span>
<span id="cb88-3"><a href="coding-best-practices.html#cb88-3" aria-hidden="true" tabindex="-1"></a>bands <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;B4&#39;</span>, <span class="st">&#39;B3&#39;</span>, <span class="st">&#39;B2&#39;</span>)</span>
<span id="cb88-4"><a href="coding-best-practices.html#cb88-4" aria-hidden="true" tabindex="-1"></a>optimizedConvolution <span class="ot">&lt;-</span> composite<span class="sc">$</span><span class="fu">select</span>(bands)<span class="sc">$</span><span class="fu">reduceNeighborhood</span>(</span>
<span id="cb88-5"><a href="coding-best-practices.html#cb88-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">reducer =</span> ee<span class="sc">$</span>Reducer<span class="sc">$</span><span class="fu">mean</span>(),</span>
<span id="cb88-6"><a href="coding-best-practices.html#cb88-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">kernel =</span> ee<span class="sc">$</span>Kernel<span class="sc">$</span><span class="fu">square</span>(<span class="dv">3</span>),</span>
<span id="cb88-7"><a href="coding-best-practices.html#cb88-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">optimization =</span> <span class="st">&quot;boxcar&quot;</span> <span class="co"># Suitable optimization for mean.</span></span>
<span id="cb88-8"><a href="coding-best-practices.html#cb88-8" aria-hidden="true" tabindex="-1"></a>)<span class="sc">$</span><span class="fu">rename</span>(bands)</span>
<span id="cb88-9"><a href="coding-best-practices.html#cb88-9" aria-hidden="true" tabindex="-1"></a>viz <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">bands =</span> bands, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">72</span>)</span>
<span id="cb88-10"><a href="coding-best-practices.html#cb88-10" aria-hidden="true" tabindex="-1"></a>Map<span class="sc">$</span><span class="fu">setCenter</span>(<span class="sc">-</span><span class="fl">122.0703</span>, <span class="fl">37.3872</span>, <span class="dv">11</span>)</span>
<span id="cb88-11"><a href="coding-best-practices.html#cb88-11" aria-hidden="true" tabindex="-1"></a>Map<span class="sc">$</span><span class="fu">addLayer</span>(composite, viz, <span class="st">&quot;composite&quot;</span>) <span class="sc">+</span></span>
<span id="cb88-12"><a href="coding-best-practices.html#cb88-12" aria-hidden="true" tabindex="-1"></a>Map<span class="sc">$</span><span class="fu">addLayer</span>(optimizedConvolution, viz, <span class="st">&quot;optimizedConvolution&quot;</span>)</span></code></pre></div>
</div>
<div id="dont-sample-more-data-than-you-need" class="section level2 unnumbered">
<h2><strong>Don’t sample more data than you need</strong></h2>
<p>Resist the urge to increase your training dataset size unnecessarily. Although increasing the amount of training data is an effective machine learning strategy in some circumstances, it can also increase computational cost with no corresponding increase in accuracy. (For an understanding of when to increase training dataset size, see <a href="https://www.deeplearning.ai/programs/">this reference</a>). The following example demonstrates how requesting too much training data can result in the dreaded “Computed value is too large” error:</p>
<p><img src="images/thumb_down.png" width=25px>
  <strong>Bad</strong> — Don’t sample too much data!</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="coding-best-practices.html#cb89-1" aria-hidden="true" tabindex="-1"></a>l8raw <span class="ot">&lt;-</span> ee<span class="sc">$</span><span class="fu">ImageCollection</span>(<span class="st">&#39;LANDSAT/LC08/C01/T1_RT&#39;</span>)</span>
<span id="cb89-2"><a href="coding-best-practices.html#cb89-2" aria-hidden="true" tabindex="-1"></a>composite <span class="ot">&lt;-</span> ee<span class="sc">$</span>Algorithms<span class="sc">$</span>Landsat<span class="sc">$</span><span class="fu">simpleComposite</span>(l8raw)</span>
<span id="cb89-3"><a href="coding-best-practices.html#cb89-3" aria-hidden="true" tabindex="-1"></a>labels <span class="ot">&lt;-</span> ee<span class="sc">$</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;projects/google/demo_landcover_labels&#39;</span>)</span>
<span id="cb89-4"><a href="coding-best-practices.html#cb89-4" aria-hidden="true" tabindex="-1"></a><span class="co"># No!  Not necessary.  Don&#39;t do this:</span></span>
<span id="cb89-5"><a href="coding-best-practices.html#cb89-5" aria-hidden="true" tabindex="-1"></a>labels <span class="ot">&lt;-</span> labels<span class="sc">$</span><span class="fu">map</span>(<span class="cf">function</span>(f){f<span class="sc">$</span><span class="fu">buffer</span>(<span class="dv">100000</span>, <span class="dv">1000</span>)})</span>
<span id="cb89-6"><a href="coding-best-practices.html#cb89-6" aria-hidden="true" tabindex="-1"></a>bands <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;B2&#39;</span>, <span class="st">&#39;B3&#39;</span>, <span class="st">&#39;B4&#39;</span>, <span class="st">&#39;B5&#39;</span>, <span class="st">&#39;B6&#39;</span>, <span class="st">&#39;B7&#39;</span>)</span>
<span id="cb89-7"><a href="coding-best-practices.html#cb89-7" aria-hidden="true" tabindex="-1"></a>training <span class="ot">&lt;-</span> composite<span class="sc">$</span><span class="fu">select</span>(bands)<span class="sc">$</span><span class="fu">sampleRegions</span>(</span>
<span id="cb89-8"><a href="coding-best-practices.html#cb89-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">collection =</span> labels,</span>
<span id="cb89-9"><a href="coding-best-practices.html#cb89-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">properties =</span> <span class="fu">list</span>(<span class="st">&quot;landcover&quot;</span>),</span>
<span id="cb89-10"><a href="coding-best-practices.html#cb89-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">scale =</span> <span class="dv">30</span></span>
<span id="cb89-11"><a href="coding-best-practices.html#cb89-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb89-12"><a href="coding-best-practices.html#cb89-12" aria-hidden="true" tabindex="-1"></a>classifier <span class="ot">&lt;-</span> ee<span class="sc">$</span>Classifier<span class="sc">$</span><span class="fu">smileCart</span>()<span class="sc">$</span><span class="fu">train</span>(</span>
<span id="cb89-13"><a href="coding-best-practices.html#cb89-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">features =</span> training,</span>
<span id="cb89-14"><a href="coding-best-practices.html#cb89-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">classProperty =</span> <span class="st">&quot;landcover&quot;</span>,</span>
<span id="cb89-15"><a href="coding-best-practices.html#cb89-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">inputProperties =</span> bands</span>
<span id="cb89-16"><a href="coding-best-practices.html#cb89-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb89-17"><a href="coding-best-practices.html#cb89-17" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(classifier<span class="sc">$</span><span class="fu">explain</span>()) <span class="co"># Computed value is too large</span></span></code></pre></div>
<p>The better approach is to start with a moderate amount of data and tune the hyperparameters of the classifier to determine if you can achieve your desired accuracy:</p>
<p><img src="images/thumb_up.png" width=25px>
  <strong>Good</strong> — Tune hyperparameters.</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="coding-best-practices.html#cb90-1" aria-hidden="true" tabindex="-1"></a>l8raw <span class="ot">&lt;-</span> ee<span class="sc">$</span><span class="fu">ImageCollection</span>(<span class="st">&quot;LANDSAT/LC08/C01/T1_RT&quot;</span>)</span>
<span id="cb90-2"><a href="coding-best-practices.html#cb90-2" aria-hidden="true" tabindex="-1"></a>composite <span class="ot">&lt;-</span> ee<span class="sc">$</span>Algorithms<span class="sc">$</span>Landsat<span class="sc">$</span><span class="fu">simpleComposite</span>(l8raw)</span>
<span id="cb90-3"><a href="coding-best-practices.html#cb90-3" aria-hidden="true" tabindex="-1"></a>labels <span class="ot">&lt;-</span> ee<span class="sc">$</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;projects/google/demo_landcover_labels&quot;</span>)</span>
<span id="cb90-4"><a href="coding-best-practices.html#cb90-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Increase the data a little bit, possibly introducing noise.</span></span>
<span id="cb90-5"><a href="coding-best-practices.html#cb90-5" aria-hidden="true" tabindex="-1"></a>labels <span class="ot">&lt;-</span> labels<span class="sc">$</span><span class="fu">map</span>(<span class="cf">function</span>(f) {f<span class="sc">$</span><span class="fu">buffer</span>(<span class="dv">100</span>, <span class="dv">10</span>)})</span>
<span id="cb90-6"><a href="coding-best-practices.html#cb90-6" aria-hidden="true" tabindex="-1"></a>bands <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;B2&#39;</span>, <span class="st">&#39;B3&#39;</span>, <span class="st">&#39;B4&#39;</span>, <span class="st">&#39;B5&#39;</span>, <span class="st">&#39;B6&#39;</span>, <span class="st">&#39;B7&#39;</span>)</span>
<span id="cb90-7"><a href="coding-best-practices.html#cb90-7" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> composite<span class="sc">$</span><span class="fu">select</span>(bands)<span class="sc">$</span><span class="fu">sampleRegions</span>(</span>
<span id="cb90-8"><a href="coding-best-practices.html#cb90-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">collection =</span> labels,</span>
<span id="cb90-9"><a href="coding-best-practices.html#cb90-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">properties =</span> <span class="fu">list</span>(<span class="st">&quot;landcover&quot;</span>),</span>
<span id="cb90-10"><a href="coding-best-practices.html#cb90-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">scale =</span> <span class="dv">30</span></span>
<span id="cb90-11"><a href="coding-best-practices.html#cb90-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb90-12"><a href="coding-best-practices.html#cb90-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a column of uniform random numbers called &#39;random&#39;.</span></span>
<span id="cb90-13"><a href="coding-best-practices.html#cb90-13" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> data<span class="sc">$</span><span class="fu">randomColumn</span>()</span>
<span id="cb90-14"><a href="coding-best-practices.html#cb90-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Partition into training and testing.</span></span>
<span id="cb90-15"><a href="coding-best-practices.html#cb90-15" aria-hidden="true" tabindex="-1"></a>training <span class="ot">&lt;-</span> data<span class="sc">$</span><span class="fu">filter</span>(ee<span class="sc">$</span>Filter<span class="sc">$</span><span class="fu">lt</span>(<span class="st">&quot;random&quot;</span>, <span class="fl">0.5</span>))</span>
<span id="cb90-16"><a href="coding-best-practices.html#cb90-16" aria-hidden="true" tabindex="-1"></a>testing <span class="ot">&lt;-</span> data<span class="sc">$</span><span class="fu">filter</span>(ee<span class="sc">$</span>Filter<span class="sc">$</span><span class="fu">gte</span>(<span class="st">&quot;random&quot;</span>, <span class="fl">0.5</span>))</span>
<span id="cb90-17"><a href="coding-best-practices.html#cb90-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Tune the minLeafPopulation parameter.</span></span>
<span id="cb90-18"><a href="coding-best-practices.html#cb90-18" aria-hidden="true" tabindex="-1"></a>minLeafPops <span class="ot">&lt;-</span> ee<span class="sc">$</span>List<span class="sc">$</span><span class="fu">sequence</span>(<span class="dv">1</span>, <span class="dv">10</span>)</span>
<span id="cb90-19"><a href="coding-best-practices.html#cb90-19" aria-hidden="true" tabindex="-1"></a>accuracies <span class="ot">&lt;-</span> minLeafPops<span class="sc">$</span><span class="fu">map</span>(</span>
<span id="cb90-20"><a href="coding-best-practices.html#cb90-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ee_utils_pyfunc</span>(</span>
<span id="cb90-21"><a href="coding-best-practices.html#cb90-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(p) {</span>
<span id="cb90-22"><a href="coding-best-practices.html#cb90-22" aria-hidden="true" tabindex="-1"></a>      classifier <span class="ot">&lt;-</span> ee<span class="sc">$</span>Classifier<span class="sc">$</span><span class="fu">smileCart</span>(<span class="at">minLeafPopulation =</span> p)<span class="sc">$</span></span>
<span id="cb90-23"><a href="coding-best-practices.html#cb90-23" aria-hidden="true" tabindex="-1"></a>        <span class="fu">train</span>(</span>
<span id="cb90-24"><a href="coding-best-practices.html#cb90-24" aria-hidden="true" tabindex="-1"></a>          <span class="at">features =</span> training,</span>
<span id="cb90-25"><a href="coding-best-practices.html#cb90-25" aria-hidden="true" tabindex="-1"></a>          <span class="at">classProperty =</span> <span class="st">&quot;landcover&quot;</span>,</span>
<span id="cb90-26"><a href="coding-best-practices.html#cb90-26" aria-hidden="true" tabindex="-1"></a>          <span class="at">inputProperties =</span> bands</span>
<span id="cb90-27"><a href="coding-best-practices.html#cb90-27" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb90-28"><a href="coding-best-practices.html#cb90-28" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb90-29"><a href="coding-best-practices.html#cb90-29" aria-hidden="true" tabindex="-1"></a>      testing<span class="sc">$</span></span>
<span id="cb90-30"><a href="coding-best-practices.html#cb90-30" aria-hidden="true" tabindex="-1"></a>        <span class="fu">classify</span>(classifier)<span class="sc">$</span></span>
<span id="cb90-31"><a href="coding-best-practices.html#cb90-31" aria-hidden="true" tabindex="-1"></a>        <span class="fu">errorMatrix</span>(<span class="st">&quot;landcover&quot;</span>, <span class="st">&quot;classification&quot;</span>)<span class="sc">$</span></span>
<span id="cb90-32"><a href="coding-best-practices.html#cb90-32" aria-hidden="true" tabindex="-1"></a>        <span class="fu">accuracy</span>()</span>
<span id="cb90-33"><a href="coding-best-practices.html#cb90-33" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb90-34"><a href="coding-best-practices.html#cb90-34" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb90-35"><a href="coding-best-practices.html#cb90-35" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb90-36"><a href="coding-best-practices.html#cb90-36" aria-hidden="true" tabindex="-1"></a>minLeafPopulation_array <span class="ot">&lt;-</span> accuracies<span class="sc">$</span><span class="fu">getInfo</span>()</span>
<span id="cb90-37"><a href="coding-best-practices.html#cb90-37" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb90-38"><a href="coding-best-practices.html#cb90-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> minLeafPopulation_array,</span>
<span id="cb90-39"><a href="coding-best-practices.html#cb90-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">&quot;b&quot;</span>, </span>
<span id="cb90-40"><a href="coding-best-practices.html#cb90-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="st">&quot;blue&quot;</span>,</span>
<span id="cb90-41"><a href="coding-best-practices.html#cb90-41" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd =</span> <span class="dv">2</span>,</span>
<span id="cb90-42"><a href="coding-best-practices.html#cb90-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">&quot;accuracy&quot;</span>,</span>
<span id="cb90-43"><a href="coding-best-practices.html#cb90-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">10</span>),</span>
<span id="cb90-44"><a href="coding-best-practices.html#cb90-44" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">&quot;value&quot;</span>,</span>
<span id="cb90-45"><a href="coding-best-practices.html#cb90-45" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">&quot;Hyperparameter tunning (minLeafPopulation)&quot;</span></span>
<span id="cb90-46"><a href="coding-best-practices.html#cb90-46" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>In this example, the classifier is already very accurate, so there’s not much tuning to do. You might want to choose the smallest tree possible (i.e. largest <code>minLeafPopulation</code>) that still has the required accuracy.</p>
</div>
<div id="export-intermediate-results" class="section level2 unnumbered">
<h2><strong>Export intermediate results</strong></h2>
<p>Suppose your objective is to take samples from a relatively complex computed image. It is often more efficient to <code>Export</code> the image <code>toAsset()</code>, load the exported image, then sample. For example:</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="coding-best-practices.html#cb91-1" aria-hidden="true" tabindex="-1"></a>image <span class="ot">&lt;-</span> ee<span class="sc">$</span><span class="fu">Image</span>(<span class="st">&#39;UMD/hansen/global_forest_change_2018_v1_6&#39;</span>)</span>
<span id="cb91-2"><a href="coding-best-practices.html#cb91-2" aria-hidden="true" tabindex="-1"></a>geometry <span class="ot">&lt;-</span> ee<span class="sc">$</span>Geometry<span class="sc">$</span><span class="fu">Polygon</span>(</span>
<span id="cb91-3"><a href="coding-best-practices.html#cb91-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">coords =</span> <span class="fu">list</span>(</span>
<span id="cb91-4"><a href="coding-best-practices.html#cb91-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="sc">-</span><span class="fl">76.64069800085349</span>, <span class="fl">5.511777325802095</span>),</span>
<span id="cb91-5"><a href="coding-best-practices.html#cb91-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="sc">-</span><span class="fl">76.64069800085349</span>, <span class="sc">-</span><span class="fl">20.483938229362376</span>),</span>
<span id="cb91-6"><a href="coding-best-practices.html#cb91-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="sc">-</span><span class="fl">35.15632300085349</span>, <span class="sc">-</span><span class="fl">20.483938229362376</span>),</span>
<span id="cb91-7"><a href="coding-best-practices.html#cb91-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="sc">-</span><span class="fl">35.15632300085349</span>, <span class="fl">5.511777325802095</span>)</span>
<span id="cb91-8"><a href="coding-best-practices.html#cb91-8" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb91-9"><a href="coding-best-practices.html#cb91-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">proj =</span>  <span class="st">&quot;EPSG:4326&quot;</span>,</span>
<span id="cb91-10"><a href="coding-best-practices.html#cb91-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">geodesic =</span>  <span class="cn">FALSE</span></span>
<span id="cb91-11"><a href="coding-best-practices.html#cb91-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb91-12"><a href="coding-best-practices.html#cb91-12" aria-hidden="true" tabindex="-1"></a>testRegion <span class="ot">&lt;-</span> ee<span class="sc">$</span>Geometry<span class="sc">$</span><span class="fu">Polygon</span>(</span>
<span id="cb91-13"><a href="coding-best-practices.html#cb91-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">coords =</span> <span class="fu">list</span>(</span>
<span id="cb91-14"><a href="coding-best-practices.html#cb91-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="sc">-</span><span class="fl">48.86726050085349</span>, <span class="sc">-</span><span class="fl">3.0475996402515717</span>),</span>
<span id="cb91-15"><a href="coding-best-practices.html#cb91-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="sc">-</span><span class="fl">48.86726050085349</span>, <span class="sc">-</span><span class="fl">3.9248707849303295</span>),</span>
<span id="cb91-16"><a href="coding-best-practices.html#cb91-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="sc">-</span><span class="fl">47.46101050085349</span>, <span class="sc">-</span><span class="fl">3.9248707849303295</span>),</span>
<span id="cb91-17"><a href="coding-best-practices.html#cb91-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="sc">-</span><span class="fl">47.46101050085349</span>, <span class="sc">-</span><span class="fl">3.0475996402515717</span>)</span>
<span id="cb91-18"><a href="coding-best-practices.html#cb91-18" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb91-19"><a href="coding-best-practices.html#cb91-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">proj =</span> <span class="st">&quot;EPSG:4326&quot;</span>,</span>
<span id="cb91-20"><a href="coding-best-practices.html#cb91-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">geodesic =</span> <span class="cn">FALSE</span></span>
<span id="cb91-21"><a href="coding-best-practices.html#cb91-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb91-22"><a href="coding-best-practices.html#cb91-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Forest loss in 2016, to stratify a sample.</span></span>
<span id="cb91-23"><a href="coding-best-practices.html#cb91-23" aria-hidden="true" tabindex="-1"></a>loss <span class="ot">&lt;-</span> image<span class="sc">$</span><span class="fu">select</span>(<span class="st">&quot;lossyear&quot;</span>)</span>
<span id="cb91-24"><a href="coding-best-practices.html#cb91-24" aria-hidden="true" tabindex="-1"></a>loss16 <span class="ot">&lt;-</span> loss<span class="sc">$</span><span class="fu">eq</span>(<span class="dv">16</span>)<span class="sc">$</span><span class="fu">rename</span>(<span class="st">&quot;loss16&quot;</span>)</span>
<span id="cb91-25"><a href="coding-best-practices.html#cb91-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Cloud masking function.</span></span>
<span id="cb91-26"><a href="coding-best-practices.html#cb91-26" aria-hidden="true" tabindex="-1"></a>maskL8sr <span class="ot">&lt;-</span> <span class="cf">function</span>(image) {</span>
<span id="cb91-27"><a href="coding-best-practices.html#cb91-27" aria-hidden="true" tabindex="-1"></a>  cloudShadowBitMask <span class="ot">&lt;-</span> <span class="fu">bitwShiftL</span>(<span class="dv">1</span>, <span class="dv">3</span>)</span>
<span id="cb91-28"><a href="coding-best-practices.html#cb91-28" aria-hidden="true" tabindex="-1"></a>  cloudsBitMask <span class="ot">&lt;-</span> <span class="fu">bitwShiftL</span>(<span class="dv">1</span>, <span class="dv">5</span>)</span>
<span id="cb91-29"><a href="coding-best-practices.html#cb91-29" aria-hidden="true" tabindex="-1"></a>  qa <span class="ot">&lt;-</span> image<span class="sc">$</span><span class="fu">select</span>(<span class="st">&#39;pixel_qa&#39;</span>)</span>
<span id="cb91-30"><a href="coding-best-practices.html#cb91-30" aria-hidden="true" tabindex="-1"></a>  mask <span class="ot">&lt;-</span> qa<span class="sc">$</span><span class="fu">bitwiseAnd</span>(cloudShadowBitMask)<span class="sc">$</span><span class="fu">eq</span>(<span class="dv">0</span>)<span class="sc">$</span></span>
<span id="cb91-31"><a href="coding-best-practices.html#cb91-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">And</span>(qa<span class="sc">$</span><span class="fu">bitwiseAnd</span>(cloudsBitMask)<span class="sc">$</span><span class="fu">eq</span>(<span class="dv">0</span>))</span>
<span id="cb91-32"><a href="coding-best-practices.html#cb91-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb91-33"><a href="coding-best-practices.html#cb91-33" aria-hidden="true" tabindex="-1"></a>  image<span class="sc">$</span><span class="fu">updateMask</span>(mask)<span class="sc">$</span></span>
<span id="cb91-34"><a href="coding-best-practices.html#cb91-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">divide</span>(<span class="dv">10000</span>)<span class="sc">$</span></span>
<span id="cb91-35"><a href="coding-best-practices.html#cb91-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="st">&quot;B[0-9]*&quot;</span>)<span class="sc">$</span></span>
<span id="cb91-36"><a href="coding-best-practices.html#cb91-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">copyProperties</span>(image, <span class="fu">list</span>(<span class="st">&quot;system:time_start&quot;</span>))</span>
<span id="cb91-37"><a href="coding-best-practices.html#cb91-37" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb91-38"><a href="coding-best-practices.html#cb91-38" aria-hidden="true" tabindex="-1"></a>collection <span class="ot">&lt;-</span> ee<span class="sc">$</span><span class="fu">ImageCollection</span>(<span class="st">&quot;LANDSAT/LC08/C01/T1_SR&quot;</span>)<span class="sc">$</span><span class="fu">map</span>(maskL8sr)</span>
<span id="cb91-39"><a href="coding-best-practices.html#cb91-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Create two annual cloud-free composites.</span></span>
<span id="cb91-40"><a href="coding-best-practices.html#cb91-40" aria-hidden="true" tabindex="-1"></a>composite1 <span class="ot">&lt;-</span> collection<span class="sc">$</span><span class="fu">filterDate</span>(<span class="st">&#39;2015-01-01&#39;</span>, <span class="st">&#39;2015-12-31&#39;</span>)<span class="sc">$</span><span class="fu">median</span>()</span>
<span id="cb91-41"><a href="coding-best-practices.html#cb91-41" aria-hidden="true" tabindex="-1"></a>composite2 <span class="ot">&lt;-</span> collection<span class="sc">$</span><span class="fu">filterDate</span>(<span class="st">&#39;2017-01-01&#39;</span>, <span class="st">&#39;2017-12-31&#39;</span>)<span class="sc">$</span><span class="fu">median</span>()</span>
<span id="cb91-42"><a href="coding-best-practices.html#cb91-42" aria-hidden="true" tabindex="-1"></a><span class="co"># We want a strtatified sample of this stack.</span></span>
<span id="cb91-43"><a href="coding-best-practices.html#cb91-43" aria-hidden="true" tabindex="-1"></a>stack <span class="ot">&lt;-</span> composite1<span class="sc">$</span><span class="fu">addBands</span>(composite2)<span class="sc">$</span><span class="fu">float</span>() <span class="co"># Export the smallest size possible.</span></span>
<span id="cb91-44"><a href="coding-best-practices.html#cb91-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Export the image.  This block is commented because the export is complete.</span></span>
<span id="cb91-45"><a href="coding-best-practices.html#cb91-45" aria-hidden="true" tabindex="-1"></a><span class="co"># link &lt;- &quot;0b8023b0af6c1b0ac7b5be649b54db06&quot;</span></span>
<span id="cb91-46"><a href="coding-best-practices.html#cb91-46" aria-hidden="true" tabindex="-1"></a><span class="co"># desc &lt;- paste0(ee_get_assethome(), &quot;/Logistic_regression_stack_&quot;, link)</span></span>
<span id="cb91-47"><a href="coding-best-practices.html#cb91-47" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb91-48"><a href="coding-best-practices.html#cb91-48" aria-hidden="true" tabindex="-1"></a><span class="co"># #ee_image_info(stack)</span></span>
<span id="cb91-49"><a href="coding-best-practices.html#cb91-49" aria-hidden="true" tabindex="-1"></a><span class="co"># task &lt;- ee_image_to_asset(</span></span>
<span id="cb91-50"><a href="coding-best-practices.html#cb91-50" aria-hidden="true" tabindex="-1"></a><span class="co">#   image = stack,</span></span>
<span id="cb91-51"><a href="coding-best-practices.html#cb91-51" aria-hidden="true" tabindex="-1"></a><span class="co">#   description = link,</span></span>
<span id="cb91-52"><a href="coding-best-practices.html#cb91-52" aria-hidden="true" tabindex="-1"></a><span class="co">#   assetId = desc,</span></span>
<span id="cb91-53"><a href="coding-best-practices.html#cb91-53" aria-hidden="true" tabindex="-1"></a><span class="co">#   region = geometry,</span></span>
<span id="cb91-54"><a href="coding-best-practices.html#cb91-54" aria-hidden="true" tabindex="-1"></a><span class="co">#   scale = 100,</span></span>
<span id="cb91-55"><a href="coding-best-practices.html#cb91-55" aria-hidden="true" tabindex="-1"></a><span class="co">#   maxPixels = 1e10</span></span>
<span id="cb91-56"><a href="coding-best-practices.html#cb91-56" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb91-57"><a href="coding-best-practices.html#cb91-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb91-58"><a href="coding-best-practices.html#cb91-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the exported image.</span></span>
<span id="cb91-59"><a href="coding-best-practices.html#cb91-59" aria-hidden="true" tabindex="-1"></a>exportedStack <span class="ot">&lt;-</span> ee<span class="sc">$</span><span class="fu">Image</span>(</span>
<span id="cb91-60"><a href="coding-best-practices.html#cb91-60" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;projects/google/Logistic_regression_stack_0b8023b0af6c1b0ac7b5be649b54db06&quot;</span></span>
<span id="cb91-61"><a href="coding-best-practices.html#cb91-61" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb91-62"><a href="coding-best-practices.html#cb91-62" aria-hidden="true" tabindex="-1"></a><span class="co"># Take a very small sample first, to debug.</span></span>
<span id="cb91-63"><a href="coding-best-practices.html#cb91-63" aria-hidden="true" tabindex="-1"></a>testSample <span class="ot">&lt;-</span> exportedStack<span class="sc">$</span><span class="fu">addBands</span>(loss16)<span class="sc">$</span><span class="fu">stratifiedSample</span>(</span>
<span id="cb91-64"><a href="coding-best-practices.html#cb91-64" aria-hidden="true" tabindex="-1"></a>  <span class="at">numPoints =</span> <span class="dv">1</span>,</span>
<span id="cb91-65"><a href="coding-best-practices.html#cb91-65" aria-hidden="true" tabindex="-1"></a>  <span class="at">classBand =</span> <span class="st">&quot;loss16&quot;</span>,</span>
<span id="cb91-66"><a href="coding-best-practices.html#cb91-66" aria-hidden="true" tabindex="-1"></a>  <span class="at">region =</span> testRegion,</span>
<span id="cb91-67"><a href="coding-best-practices.html#cb91-67" aria-hidden="true" tabindex="-1"></a>  <span class="at">scale =</span> <span class="dv">30</span>,</span>
<span id="cb91-68"><a href="coding-best-practices.html#cb91-68" aria-hidden="true" tabindex="-1"></a>  <span class="at">geometries =</span> <span class="cn">TRUE</span></span>
<span id="cb91-69"><a href="coding-best-practices.html#cb91-69" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb91-70"><a href="coding-best-practices.html#cb91-70" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(testSample<span class="sc">$</span><span class="fu">getInfo</span>()) <span class="co"># Check this in the console.</span></span>
<span id="cb91-71"><a href="coding-best-practices.html#cb91-71" aria-hidden="true" tabindex="-1"></a><span class="co"># Take a large sample.</span></span>
<span id="cb91-72"><a href="coding-best-practices.html#cb91-72" aria-hidden="true" tabindex="-1"></a>sample <span class="ot">&lt;-</span> exportedStack<span class="sc">$</span><span class="fu">addBands</span>(loss16)<span class="sc">$</span><span class="fu">stratifiedSample</span>(</span>
<span id="cb91-73"><a href="coding-best-practices.html#cb91-73" aria-hidden="true" tabindex="-1"></a>  <span class="at">numPoints =</span> <span class="dv">10000</span>,</span>
<span id="cb91-74"><a href="coding-best-practices.html#cb91-74" aria-hidden="true" tabindex="-1"></a>  <span class="at">classBand =</span> <span class="st">&quot;loss16&quot;</span>,</span>
<span id="cb91-75"><a href="coding-best-practices.html#cb91-75" aria-hidden="true" tabindex="-1"></a>  <span class="at">region =</span> geometry,</span>
<span id="cb91-76"><a href="coding-best-practices.html#cb91-76" aria-hidden="true" tabindex="-1"></a>  <span class="at">scale =</span> <span class="dv">30</span></span>
<span id="cb91-77"><a href="coding-best-practices.html#cb91-77" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb91-78"><a href="coding-best-practices.html#cb91-78" aria-hidden="true" tabindex="-1"></a><span class="co"># Export the large sample...</span></span></code></pre></div>
<p>In this example, note that the imagery is exported as float. Don’t export at double precision unless absolutely necessary.</p>
<p>Once the export is completed, reload the asset and proceed with sampling from it. Note that a very small sample over a very small test area is run first, for debugging. When that is shown to succeed, take a larger sample and export it. Such large samples typically need to be exported. Do not expect such samples to be available interactively (for example through <code>print()</code>) or useable (for example as input to a classifier) without exporting them first.</p>
</div>
<div id="join-vs.-map-filter" class="section level2 unnumbered">
<h2><strong>Join vs. map-filter</strong></h2>
<p>Suppose you want to join collections based on time, location or some metadata property. Generally, this is most efficiently accomplished with a join. The following example does a spatio-temporal join between the Landsat 8 and Sentinel-2 collections:</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="coding-best-practices.html#cb92-1" aria-hidden="true" tabindex="-1"></a>s2 <span class="ot">&lt;-</span> ee<span class="sc">$</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2&quot;</span>)<span class="sc">$</span></span>
<span id="cb92-2"><a href="coding-best-practices.html#cb92-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filterBounds</span>(ee<span class="sc">$</span>Geometry<span class="sc">$</span><span class="fu">Point</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="fl">2.0205</span>, <span class="fl">48.647</span>)))</span>
<span id="cb92-3"><a href="coding-best-practices.html#cb92-3" aria-hidden="true" tabindex="-1"></a>l8 <span class="ot">&lt;-</span> ee<span class="sc">$</span><span class="fu">ImageCollection</span>(<span class="st">&quot;LANDSAT/LC08/C01/T1_SR&quot;</span>)</span>
<span id="cb92-4"><a href="coding-best-practices.html#cb92-4" aria-hidden="true" tabindex="-1"></a>joined <span class="ot">&lt;-</span> ee<span class="sc">$</span>Join<span class="sc">$</span><span class="fu">saveAll</span>(<span class="st">&quot;landsat&quot;</span>)<span class="sc">$</span><span class="fu">apply</span>(</span>
<span id="cb92-5"><a href="coding-best-practices.html#cb92-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">primary =</span> s2,</span>
<span id="cb92-6"><a href="coding-best-practices.html#cb92-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">secondary =</span> l8,</span>
<span id="cb92-7"><a href="coding-best-practices.html#cb92-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">condition =</span> ee<span class="sc">$</span>Filter<span class="sc">$</span><span class="fu">And</span>(</span>
<span id="cb92-8"><a href="coding-best-practices.html#cb92-8" aria-hidden="true" tabindex="-1"></a>    ee<span class="sc">$</span>Filter<span class="sc">$</span><span class="fu">maxDifference</span>(</span>
<span id="cb92-9"><a href="coding-best-practices.html#cb92-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">difference =</span> <span class="dv">1000</span> <span class="sc">*</span> <span class="dv">60</span> <span class="sc">*</span> <span class="dv">60</span> <span class="sc">*</span> <span class="dv">24</span>, <span class="co"># One day in milliseconds</span></span>
<span id="cb92-10"><a href="coding-best-practices.html#cb92-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">leftField =</span> <span class="st">&quot;system:time_start&quot;</span>,</span>
<span id="cb92-11"><a href="coding-best-practices.html#cb92-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">rightField =</span> <span class="st">&quot;system:time_start&quot;</span></span>
<span id="cb92-12"><a href="coding-best-practices.html#cb92-12" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb92-13"><a href="coding-best-practices.html#cb92-13" aria-hidden="true" tabindex="-1"></a>    ee<span class="sc">$</span>Filter<span class="sc">$</span><span class="fu">intersects</span>(</span>
<span id="cb92-14"><a href="coding-best-practices.html#cb92-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">leftField =</span> <span class="st">&quot;.geo&quot;</span>,</span>
<span id="cb92-15"><a href="coding-best-practices.html#cb92-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">rightField =</span> <span class="st">&quot;.geo&quot;</span></span>
<span id="cb92-16"><a href="coding-best-practices.html#cb92-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb92-17"><a href="coding-best-practices.html#cb92-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb92-18"><a href="coding-best-practices.html#cb92-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb92-19"><a href="coding-best-practices.html#cb92-19" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(joined<span class="sc">$</span><span class="fu">first</span>()<span class="sc">$</span><span class="fu">getInfo</span>())</span></code></pre></div>
<p>Although you should try a join first (<code>Export</code> if needed), occasionally a <code>filter()</code> within a <code>map()</code> can also be effective, particularly for very large collections.</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="coding-best-practices.html#cb93-1" aria-hidden="true" tabindex="-1"></a>s2 <span class="ot">&lt;-</span> ee<span class="sc">$</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2&quot;</span>)<span class="sc">$</span></span>
<span id="cb93-2"><a href="coding-best-practices.html#cb93-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filterBounds</span>(ee<span class="sc">$</span>Geometry<span class="sc">$</span><span class="fu">Point</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="fl">2.0205</span>, <span class="fl">48.647</span>)))</span>
<span id="cb93-3"><a href="coding-best-practices.html#cb93-3" aria-hidden="true" tabindex="-1"></a>l8 <span class="ot">&lt;-</span> ee<span class="sc">$</span><span class="fu">ImageCollection</span>(<span class="st">&quot;LANDSAT/LC08/C01/T1_SR&quot;</span>)</span>
<span id="cb93-4"><a href="coding-best-practices.html#cb93-4" aria-hidden="true" tabindex="-1"></a>mappedFilter <span class="ot">&lt;-</span> s2<span class="sc">$</span><span class="fu">map</span>(<span class="cf">function</span>(image) {</span>
<span id="cb93-5"><a href="coding-best-practices.html#cb93-5" aria-hidden="true" tabindex="-1"></a>  date <span class="ot">&lt;-</span> image<span class="sc">$</span><span class="fu">date</span>()</span>
<span id="cb93-6"><a href="coding-best-practices.html#cb93-6" aria-hidden="true" tabindex="-1"></a>  landsat <span class="ot">&lt;-</span> l8<span class="sc">$</span></span>
<span id="cb93-7"><a href="coding-best-practices.html#cb93-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filterBounds</span>(image<span class="sc">$</span><span class="fu">geometry</span>())<span class="sc">$</span></span>
<span id="cb93-8"><a href="coding-best-practices.html#cb93-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filterDate</span>(date<span class="sc">$</span><span class="fu">advance</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="st">&quot;day&quot;</span>), date<span class="sc">$</span><span class="fu">advance</span>(<span class="dv">1</span>, <span class="st">&quot;day&quot;</span>))</span>
<span id="cb93-9"><a href="coding-best-practices.html#cb93-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return the input image with matching scenes in a property.</span></span>
<span id="cb93-10"><a href="coding-best-practices.html#cb93-10" aria-hidden="true" tabindex="-1"></a>  image<span class="sc">$</span><span class="fu">set</span>(</span>
<span id="cb93-11"><a href="coding-best-practices.html#cb93-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(</span>
<span id="cb93-12"><a href="coding-best-practices.html#cb93-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">landsat =</span> landsat,</span>
<span id="cb93-13"><a href="coding-best-practices.html#cb93-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">size =</span> landsat<span class="sc">$</span><span class="fu">size</span>()</span>
<span id="cb93-14"><a href="coding-best-practices.html#cb93-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb93-15"><a href="coding-best-practices.html#cb93-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb93-16"><a href="coding-best-practices.html#cb93-16" aria-hidden="true" tabindex="-1"></a>})<span class="sc">$</span><span class="fu">filter</span>(ee<span class="sc">$</span>Filter<span class="sc">$</span><span class="fu">gt</span>(<span class="st">&quot;size&quot;</span>, <span class="dv">0</span>))</span>
<span id="cb93-17"><a href="coding-best-practices.html#cb93-17" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mappedFilter<span class="sc">$</span><span class="fu">first</span>()<span class="sc">$</span><span class="fu">getInfo</span>())</span></code></pre></div>
</div>
<div id="reduceregion-vs.-reduceregions-vs.-for-loop" class="section level2 unnumbered">
<h2><strong>reduceRegion() vs. reduceRegions() vs. for-loop</strong></h2>
<p>Calling <code>reduceRegions()</code> with a very large or complex
<code>FeatureCollection</code> as input may result in the dreaded “Computed value
is too large” error. One potential solution is to map <code>reduceRegion()</code>
over the <code>FeatureCollection</code> instead. Another potential solution is to
use a (gasp) for-loop. Although this is strongly discouraged in Earth
Engine as described <a href="https://developers.google.com/earth-engine/guides/getstarted">here</a>, <a href="https://developers.google.com/earth-engine/tutorials/tutorial_js_03">here</a> and <a href="https://developers.google.com/earth-engine/guides/client_server">here</a>, <code>reduceRegion()</code> can be implemented in a for-loop to perform large reductions.</p>
<p>Suppose your objective is to obtain the mean of pixels (or any statistic) in each feature in a <code>FeatureCollection</code> for each image in an <code>ImageCollection</code>. The following example compares the three approaches previously described:</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="coding-best-practices.html#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Table of countries.</span></span>
<span id="cb94-2"><a href="coding-best-practices.html#cb94-2" aria-hidden="true" tabindex="-1"></a>countriesTable <span class="ot">&lt;-</span> ee<span class="sc">$</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;USDOS/LSIB_SIMPLE/2017&quot;</span>)</span>
<span id="cb94-3"><a href="coding-best-practices.html#cb94-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Time series of images.</span></span>
<span id="cb94-4"><a href="coding-best-practices.html#cb94-4" aria-hidden="true" tabindex="-1"></a>mod13a1 <span class="ot">&lt;-</span> ee<span class="sc">$</span><span class="fu">ImageCollection</span>(<span class="st">&quot;MODIS/006/MOD13A1&quot;</span>)</span>
<span id="cb94-5"><a href="coding-best-practices.html#cb94-5" aria-hidden="true" tabindex="-1"></a><span class="co"># MODIS vegetation indices (always use the most recent version).</span></span>
<span id="cb94-6"><a href="coding-best-practices.html#cb94-6" aria-hidden="true" tabindex="-1"></a>band <span class="ot">&lt;-</span> <span class="st">&quot;NDVI&quot;</span></span>
<span id="cb94-7"><a href="coding-best-practices.html#cb94-7" aria-hidden="true" tabindex="-1"></a>imagery <span class="ot">&lt;-</span> mod13a1<span class="sc">$</span><span class="fu">select</span>(band)</span>
<span id="cb94-8"><a href="coding-best-practices.html#cb94-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Option 1: reduceRegions()</span></span>
<span id="cb94-9"><a href="coding-best-practices.html#cb94-9" aria-hidden="true" tabindex="-1"></a>testTable <span class="ot">&lt;-</span> countriesTable<span class="sc">$</span><span class="fu">limit</span>(<span class="dv">1</span>) <span class="co"># Do this outside map()s and loops.</span></span>
<span id="cb94-10"><a href="coding-best-practices.html#cb94-10" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> imagery<span class="sc">$</span><span class="fu">map</span>(<span class="cf">function</span>(image) {</span>
<span id="cb94-11"><a href="coding-best-practices.html#cb94-11" aria-hidden="true" tabindex="-1"></a>  image<span class="sc">$</span><span class="fu">reduceRegions</span>(</span>
<span id="cb94-12"><a href="coding-best-practices.html#cb94-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">collection =</span> testTable,</span>
<span id="cb94-13"><a href="coding-best-practices.html#cb94-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">reducer =</span> ee<span class="sc">$</span>Reducer<span class="sc">$</span><span class="fu">mean</span>(),</span>
<span id="cb94-14"><a href="coding-best-practices.html#cb94-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">scale =</span> <span class="dv">500</span></span>
<span id="cb94-15"><a href="coding-best-practices.html#cb94-15" aria-hidden="true" tabindex="-1"></a>  )<span class="sc">$</span><span class="fu">map</span>(<span class="cf">function</span>(f) {</span>
<span id="cb94-16"><a href="coding-best-practices.html#cb94-16" aria-hidden="true" tabindex="-1"></a>    f<span class="sc">$</span><span class="fu">set</span>(</span>
<span id="cb94-17"><a href="coding-best-practices.html#cb94-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(</span>
<span id="cb94-18"><a href="coding-best-practices.html#cb94-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">time =</span> image<span class="sc">$</span><span class="fu">date</span>()<span class="sc">$</span><span class="fu">millis</span>(),</span>
<span id="cb94-19"><a href="coding-best-practices.html#cb94-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">date =</span> image<span class="sc">$</span><span class="fu">date</span>()<span class="sc">$</span><span class="fu">format</span>()</span>
<span id="cb94-20"><a href="coding-best-practices.html#cb94-20" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb94-21"><a href="coding-best-practices.html#cb94-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb94-22"><a href="coding-best-practices.html#cb94-22" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb94-23"><a href="coding-best-practices.html#cb94-23" aria-hidden="true" tabindex="-1"></a>})<span class="sc">$</span><span class="fu">flatten</span>()</span>
<span id="cb94-24"><a href="coding-best-practices.html#cb94-24" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(data<span class="sc">$</span><span class="fu">first</span>()<span class="sc">$</span><span class="fu">getInfo</span>())</span>
<span id="cb94-25"><a href="coding-best-practices.html#cb94-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Option 2: mapped reduceRegion()</span></span>
<span id="cb94-26"><a href="coding-best-practices.html#cb94-26" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> countriesTable<span class="sc">$</span><span class="fu">map</span>(<span class="cf">function</span>(feature) {</span>
<span id="cb94-27"><a href="coding-best-practices.html#cb94-27" aria-hidden="true" tabindex="-1"></a>  imagery<span class="sc">$</span><span class="fu">map</span>(</span>
<span id="cb94-28"><a href="coding-best-practices.html#cb94-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(image) {</span>
<span id="cb94-29"><a href="coding-best-practices.html#cb94-29" aria-hidden="true" tabindex="-1"></a>      ee<span class="sc">$</span><span class="fu">Feature</span>(</span>
<span id="cb94-30"><a href="coding-best-practices.html#cb94-30" aria-hidden="true" tabindex="-1"></a>        feature<span class="sc">$</span><span class="fu">geometry</span>()<span class="sc">$</span><span class="fu">centroid</span>(<span class="dv">100</span>),</span>
<span id="cb94-31"><a href="coding-best-practices.html#cb94-31" aria-hidden="true" tabindex="-1"></a>        image<span class="sc">$</span><span class="fu">reduceRegion</span>(</span>
<span id="cb94-32"><a href="coding-best-practices.html#cb94-32" aria-hidden="true" tabindex="-1"></a>          <span class="at">reducer =</span> ee<span class="sc">$</span>Reducer<span class="sc">$</span><span class="fu">mean</span>(),</span>
<span id="cb94-33"><a href="coding-best-practices.html#cb94-33" aria-hidden="true" tabindex="-1"></a>          <span class="at">geometry =</span> feature<span class="sc">$</span><span class="fu">geometry</span>(),</span>
<span id="cb94-34"><a href="coding-best-practices.html#cb94-34" aria-hidden="true" tabindex="-1"></a>          <span class="at">scale =</span> <span class="dv">500</span></span>
<span id="cb94-35"><a href="coding-best-practices.html#cb94-35" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb94-36"><a href="coding-best-practices.html#cb94-36" aria-hidden="true" tabindex="-1"></a>      )<span class="sc">$</span><span class="fu">set</span>(</span>
<span id="cb94-37"><a href="coding-best-practices.html#cb94-37" aria-hidden="true" tabindex="-1"></a>        <span class="fu">list</span>(</span>
<span id="cb94-38"><a href="coding-best-practices.html#cb94-38" aria-hidden="true" tabindex="-1"></a>          <span class="at">time =</span> image<span class="sc">$</span><span class="fu">date</span>()<span class="sc">$</span><span class="fu">millis</span>(),</span>
<span id="cb94-39"><a href="coding-best-practices.html#cb94-39" aria-hidden="true" tabindex="-1"></a>          <span class="at">date =</span> image<span class="sc">$</span><span class="fu">date</span>()<span class="sc">$</span><span class="fu">format</span>()</span>
<span id="cb94-40"><a href="coding-best-practices.html#cb94-40" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb94-41"><a href="coding-best-practices.html#cb94-41" aria-hidden="true" tabindex="-1"></a>      )<span class="sc">$</span><span class="fu">copyProperties</span>(feature)</span>
<span id="cb94-42"><a href="coding-best-practices.html#cb94-42" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb94-43"><a href="coding-best-practices.html#cb94-43" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb94-44"><a href="coding-best-practices.html#cb94-44" aria-hidden="true" tabindex="-1"></a>})<span class="sc">$</span><span class="fu">flatten</span>()</span>
<span id="cb94-45"><a href="coding-best-practices.html#cb94-45" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(data<span class="sc">$</span><span class="fu">first</span>()<span class="sc">$</span><span class="fu">getInfo</span>())</span>
<span id="cb94-46"><a href="coding-best-practices.html#cb94-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Option 3: for-loop (WATCH OUT!)</span></span>
<span id="cb94-47"><a href="coding-best-practices.html#cb94-47" aria-hidden="true" tabindex="-1"></a>size <span class="ot">&lt;-</span> countriesTable<span class="sc">$</span><span class="fu">size</span>()</span>
<span id="cb94-48"><a href="coding-best-practices.html#cb94-48" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(size<span class="sc">$</span><span class="fu">getInfo</span>()) <span class="co"># 312</span></span>
<span id="cb94-49"><a href="coding-best-practices.html#cb94-49" aria-hidden="true" tabindex="-1"></a>countriesList <span class="ot">&lt;-</span> countriesTable<span class="sc">$</span><span class="fu">toList</span>(<span class="dv">1</span>) <span class="co"># Adjust size.</span></span>
<span id="cb94-50"><a href="coding-best-practices.html#cb94-50" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> ee<span class="sc">$</span><span class="fu">FeatureCollection</span>(<span class="fu">list</span>()) <span class="co"># Empty table.</span></span>
<span id="cb94-51"><a href="coding-best-practices.html#cb94-51" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (j <span class="cf">in</span> (<span class="fu">seq_len</span>(countriesList<span class="sc">$</span><span class="fu">length</span>()<span class="sc">$</span><span class="fu">getInfo</span>()) <span class="sc">-</span> <span class="dv">1</span>)) {</span>
<span id="cb94-52"><a href="coding-best-practices.html#cb94-52" aria-hidden="true" tabindex="-1"></a>  feature <span class="ot">&lt;-</span> ee<span class="sc">$</span><span class="fu">Feature</span>(countriesList<span class="sc">$</span><span class="fu">get</span>(j))</span>
<span id="cb94-53"><a href="coding-best-practices.html#cb94-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert ImageCollection &gt; FeatureCollection</span></span>
<span id="cb94-54"><a href="coding-best-practices.html#cb94-54" aria-hidden="true" tabindex="-1"></a>  fc <span class="ot">&lt;-</span> ee<span class="sc">$</span><span class="fu">FeatureCollection</span>(</span>
<span id="cb94-55"><a href="coding-best-practices.html#cb94-55" aria-hidden="true" tabindex="-1"></a>    imagery<span class="sc">$</span><span class="fu">map</span>(</span>
<span id="cb94-56"><a href="coding-best-practices.html#cb94-56" aria-hidden="true" tabindex="-1"></a>      <span class="cf">function</span>(image) {</span>
<span id="cb94-57"><a href="coding-best-practices.html#cb94-57" aria-hidden="true" tabindex="-1"></a>        ee<span class="sc">$</span><span class="fu">Feature</span>(</span>
<span id="cb94-58"><a href="coding-best-practices.html#cb94-58" aria-hidden="true" tabindex="-1"></a>          feature<span class="sc">$</span><span class="fu">geometry</span>()<span class="sc">$</span><span class="fu">centroid</span>(<span class="dv">100</span>),</span>
<span id="cb94-59"><a href="coding-best-practices.html#cb94-59" aria-hidden="true" tabindex="-1"></a>          image<span class="sc">$</span><span class="fu">reduceRegion</span>(</span>
<span id="cb94-60"><a href="coding-best-practices.html#cb94-60" aria-hidden="true" tabindex="-1"></a>            <span class="at">reducer =</span> ee<span class="sc">$</span>Reducer<span class="sc">$</span><span class="fu">mean</span>(),</span>
<span id="cb94-61"><a href="coding-best-practices.html#cb94-61" aria-hidden="true" tabindex="-1"></a>            <span class="at">geometry =</span> feature<span class="sc">$</span><span class="fu">geometry</span>(),</span>
<span id="cb94-62"><a href="coding-best-practices.html#cb94-62" aria-hidden="true" tabindex="-1"></a>            <span class="at">scale =</span> <span class="dv">500</span></span>
<span id="cb94-63"><a href="coding-best-practices.html#cb94-63" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb94-64"><a href="coding-best-practices.html#cb94-64" aria-hidden="true" tabindex="-1"></a>        )<span class="sc">$</span><span class="fu">set</span>(</span>
<span id="cb94-65"><a href="coding-best-practices.html#cb94-65" aria-hidden="true" tabindex="-1"></a>          <span class="fu">list</span>(</span>
<span id="cb94-66"><a href="coding-best-practices.html#cb94-66" aria-hidden="true" tabindex="-1"></a>            <span class="at">time =</span> image<span class="sc">$</span><span class="fu">date</span>()<span class="sc">$</span><span class="fu">millis</span>(),</span>
<span id="cb94-67"><a href="coding-best-practices.html#cb94-67" aria-hidden="true" tabindex="-1"></a>            <span class="at">date =</span> image<span class="sc">$</span><span class="fu">date</span>()<span class="sc">$</span><span class="fu">format</span>()</span>
<span id="cb94-68"><a href="coding-best-practices.html#cb94-68" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb94-69"><a href="coding-best-practices.html#cb94-69" aria-hidden="true" tabindex="-1"></a>        )<span class="sc">$</span><span class="fu">copyProperties</span>(feature)</span>
<span id="cb94-70"><a href="coding-best-practices.html#cb94-70" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb94-71"><a href="coding-best-practices.html#cb94-71" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb94-72"><a href="coding-best-practices.html#cb94-72" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb94-73"><a href="coding-best-practices.html#cb94-73" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> data<span class="sc">$</span><span class="fu">merge</span>(fc)</span>
<span id="cb94-74"><a href="coding-best-practices.html#cb94-74" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb94-75"><a href="coding-best-practices.html#cb94-75" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(data<span class="sc">$</span><span class="fu">first</span>()<span class="sc">$</span><span class="fu">getInfo</span>())</span></code></pre></div>
<p>Note that the <code>first()</code> thing from each collection is printed, for debugging purposes. You should not expect that the complete result will be available interactively: you’ll need to <code>Export</code>. Also note that for-loops should be used with extreme caution and only as a last resort. Finally, the for-loop requires manually obtaining the size of the input collection and hardcoding that in the appropriate locations. If any of that sounds unclear to you, don’t use a for-loop.</p>
</div>
<div id="use-forward-differencing-for-neighbors-in-time" class="section level2 unnumbered">
<h2><strong>Use forward differencing for neighbors in time</strong></h2>
<p>Suppose you have a temporally sorted <code>ImageCollection</code> (i.e. a time series) and you want to compare each image to the previous (or next) image. Rather than use <code>iterate()</code> for this purpose, it may be more efficient to use an array-based forward differencing. The following example uses this method to de-duplicate the Sentinel-2 collection, where duplicates are defined as images with the same day of year:</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="coding-best-practices.html#cb95-1" aria-hidden="true" tabindex="-1"></a>sentinel2 <span class="ot">&lt;-</span> ee<span class="sc">$</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2&quot;</span>)</span>
<span id="cb95-2"><a href="coding-best-practices.html#cb95-2" aria-hidden="true" tabindex="-1"></a>sf <span class="ot">&lt;-</span> ee<span class="sc">$</span>Geometry<span class="sc">$</span><span class="fu">Point</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="fl">122.47555371521855</span>, <span class="fl">37.76884708376152</span>))</span>
<span id="cb95-3"><a href="coding-best-practices.html#cb95-3" aria-hidden="true" tabindex="-1"></a>s2 <span class="ot">&lt;-</span> sentinel2<span class="sc">$</span></span>
<span id="cb95-4"><a href="coding-best-practices.html#cb95-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filterBounds</span>(sf)<span class="sc">$</span></span>
<span id="cb95-5"><a href="coding-best-practices.html#cb95-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filterDate</span>(<span class="st">&quot;2018-01-01&quot;</span>, <span class="st">&quot;2019-12-31&quot;</span>)</span>
<span id="cb95-6"><a href="coding-best-practices.html#cb95-6" aria-hidden="true" tabindex="-1"></a>withDoys <span class="ot">&lt;-</span> s2<span class="sc">$</span><span class="fu">map</span>(<span class="cf">function</span>(image) {</span>
<span id="cb95-7"><a href="coding-best-practices.html#cb95-7" aria-hidden="true" tabindex="-1"></a>  ndvi <span class="ot">&lt;-</span> image<span class="sc">$</span><span class="fu">normalizedDifference</span>(<span class="fu">c</span>(<span class="st">&quot;B4&quot;</span>, <span class="st">&quot;B8&quot;</span>))<span class="sc">$</span><span class="fu">rename</span>(<span class="st">&quot;ndvi&quot;</span>)</span>
<span id="cb95-8"><a href="coding-best-practices.html#cb95-8" aria-hidden="true" tabindex="-1"></a>  date <span class="ot">&lt;-</span> image<span class="sc">$</span><span class="fu">date</span>()</span>
<span id="cb95-9"><a href="coding-best-practices.html#cb95-9" aria-hidden="true" tabindex="-1"></a>  doy <span class="ot">&lt;-</span> date<span class="sc">$</span><span class="fu">getRelative</span>(<span class="st">&quot;day&quot;</span>, <span class="st">&quot;year&quot;</span>)</span>
<span id="cb95-10"><a href="coding-best-practices.html#cb95-10" aria-hidden="true" tabindex="-1"></a>  time <span class="ot">&lt;-</span> image<span class="sc">$</span><span class="fu">metadata</span>(<span class="st">&quot;system:time_start&quot;</span>)</span>
<span id="cb95-11"><a href="coding-best-practices.html#cb95-11" aria-hidden="true" tabindex="-1"></a>  doyImage <span class="ot">&lt;-</span> ee<span class="sc">$</span><span class="fu">Image</span>(doy)<span class="sc">$</span></span>
<span id="cb95-12"><a href="coding-best-practices.html#cb95-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="st">&quot;doy&quot;</span>)<span class="sc">$</span></span>
<span id="cb95-13"><a href="coding-best-practices.html#cb95-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">int</span>()</span>
<span id="cb95-14"><a href="coding-best-practices.html#cb95-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb95-15"><a href="coding-best-practices.html#cb95-15" aria-hidden="true" tabindex="-1"></a>  ndvi<span class="sc">$</span></span>
<span id="cb95-16"><a href="coding-best-practices.html#cb95-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addBands</span>(doyImage)<span class="sc">$</span></span>
<span id="cb95-17"><a href="coding-best-practices.html#cb95-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addBands</span>(time)<span class="sc">$</span></span>
<span id="cb95-18"><a href="coding-best-practices.html#cb95-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">clip</span>(image<span class="sc">$</span><span class="fu">geometry</span>()) <span class="co"># Appropriate use of clip.</span></span>
<span id="cb95-19"><a href="coding-best-practices.html#cb95-19" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb95-20"><a href="coding-best-practices.html#cb95-20" aria-hidden="true" tabindex="-1"></a>array <span class="ot">&lt;-</span> withDoys<span class="sc">$</span><span class="fu">toArray</span>()</span>
<span id="cb95-21"><a href="coding-best-practices.html#cb95-21" aria-hidden="true" tabindex="-1"></a>timeAxis <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb95-22"><a href="coding-best-practices.html#cb95-22" aria-hidden="true" tabindex="-1"></a>bandAxis <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb95-23"><a href="coding-best-practices.html#cb95-23" aria-hidden="true" tabindex="-1"></a>dedup <span class="ot">&lt;-</span> <span class="cf">function</span>(array) {</span>
<span id="cb95-24"><a href="coding-best-practices.html#cb95-24" aria-hidden="true" tabindex="-1"></a>  time <span class="ot">&lt;-</span> array<span class="sc">$</span><span class="fu">arraySlice</span>(bandAxis, <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb95-25"><a href="coding-best-practices.html#cb95-25" aria-hidden="true" tabindex="-1"></a>  sorted <span class="ot">&lt;-</span> array<span class="sc">$</span><span class="fu">arraySort</span>(time)</span>
<span id="cb95-26"><a href="coding-best-practices.html#cb95-26" aria-hidden="true" tabindex="-1"></a>  doy <span class="ot">&lt;-</span> sorted<span class="sc">$</span><span class="fu">arraySlice</span>(bandAxis, <span class="sc">-</span><span class="dv">2</span>, <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb95-27"><a href="coding-best-practices.html#cb95-27" aria-hidden="true" tabindex="-1"></a>  left <span class="ot">&lt;-</span> doy<span class="sc">$</span><span class="fu">arraySlice</span>(timeAxis, <span class="dv">1</span>)</span>
<span id="cb95-28"><a href="coding-best-practices.html#cb95-28" aria-hidden="true" tabindex="-1"></a>  right <span class="ot">&lt;-</span> doy<span class="sc">$</span><span class="fu">arraySlice</span>(timeAxis, <span class="dv">0</span>, <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb95-29"><a href="coding-best-practices.html#cb95-29" aria-hidden="true" tabindex="-1"></a>  mask <span class="ot">&lt;-</span> ee<span class="sc">$</span><span class="fu">Image</span>(ee<span class="sc">$</span><span class="fu">Array</span>(<span class="fu">list</span>(<span class="fu">list</span>(<span class="dv">1</span>))))<span class="sc">$</span></span>
<span id="cb95-30"><a href="coding-best-practices.html#cb95-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrayCat</span>(left<span class="sc">$</span><span class="fu">neq</span>(right), timeAxis)</span>
<span id="cb95-31"><a href="coding-best-practices.html#cb95-31" aria-hidden="true" tabindex="-1"></a>  array<span class="sc">$</span><span class="fu">arrayMask</span>(mask)</span>
<span id="cb95-32"><a href="coding-best-practices.html#cb95-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb95-33"><a href="coding-best-practices.html#cb95-33" aria-hidden="true" tabindex="-1"></a>deduped <span class="ot">&lt;-</span> <span class="fu">dedup</span>(array)</span>
<span id="cb95-34"><a href="coding-best-practices.html#cb95-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect these outputs to confirm that duplicates have been removed.</span></span>
<span id="cb95-35"><a href="coding-best-practices.html#cb95-35" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(array<span class="sc">$</span><span class="fu">reduceRegion</span>(<span class="st">&quot;first&quot;</span>, sf, <span class="dv">10</span>)<span class="sc">$</span><span class="fu">getInfo</span>())</span>
<span id="cb95-36"><a href="coding-best-practices.html#cb95-36" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(deduped<span class="sc">$</span><span class="fu">reduceRegion</span>(<span class="st">&quot;first&quot;</span>, sf, <span class="dv">10</span>)<span class="sc">$</span><span class="fu">getInfo</span>())</span></code></pre></div>
</div>
</div>
  </main>

  <div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page">
      <h2>On this page</h2>
      <div id="book-on-this-page"></div>

      <div class="book-extra">
        <ul class="list-unstyled">
          <li><a id="book-source" href="#">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="#">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
      </div>
    </nav>
  </div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5">
  <div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Earth Engine with R</strong>" was written by rgee team. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
<script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>

</html>
